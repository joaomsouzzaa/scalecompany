<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scale Dashboard - Demo Visual</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        /* Connection Endpoint Styles */
        .conn-hit-area {
            position: absolute;
            width: 24px;
            /* w-6 */
            height: 24px;
            /* h-6 */
            z-index: 30;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: crosshair;
        }

        .conn-hit-area.top-point {
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            align-items: flex-end;
        }

        .conn-hit-area.bottom-point {
            bottom: -12px;
            left: 50%;
            transform: translateX(-50%);
            align-items: flex-start;
        }

        .conn-dot {
            width: 8px;
            height: 8px;
            background-color: #0f172a;
            /* slate-900 */
            border: 1.5px solid white;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.15s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .conn-hit-area:hover .conn-dot {
            opacity: 1;
            transform: scale(1.2);
        }

        body {
            font-family: 'Inter', sans-serif;
        }

        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
    <script>
        // GLOBAL STATE FOR FILTERS
        let CAMPAIGN_NAMES = {}; // Map: ID -> Name
        let textFilterValue = '';

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        red: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626',
                            700: '#b91c1c',
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="text-slate-900 font-inter bg-cover bg-center bg-fixed" style="background-image: url('dashboard-bg.jpg');">
    <script>

    </script>
    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 z-50 bg-slate-900 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 to-orange-500"></div>
            <div class="mb-8 text-center">
                <h2 class="text-3xl font-bold text-slate-800 mb-2">Scale<span class="text-red-500">Marketing</span></h2>
                <p class="text-slate-500 text-sm">Faça login para acessar o painel</p>
            </div>
            <form onsubmit="event.preventDefault(); handleLogin(event)" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Email</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="mail" class="h-5 w-5 text-slate-400"></i>
                        </div>
                        <input type="email" id="login-email" required
                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors outline-none"
                            placeholder="seu@email.com">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Senha</label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="lock" class="h-5 w-5 text-slate-400"></i>
                        </div>
                        <input type="password" id="login-password" required
                            class="block w-full pl-10 pr-3 py-2.5 bg-slate-50 border border-slate-200 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-colors outline-none"
                            placeholder="••••••••">
                    </div>
                </div>
                <div id="login-error" class="hidden bg-red-50 text-red-600 text-sm p-3 rounded-lg flex items-center">
                    <i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i>
                    <span>Credenciais inválidas</span>
                </div>
                <button type="submit" id="login-btn"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-all transform hover:scale-[1.02]">
                    Entrar
                </button>
            </form>
            <div class="mt-6 text-center text-xs text-slate-400">
                &copy; 2026 Scale Marketing. Todos os direitos reservados.
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden w-full relative">

        <!-- Mobile Header -->
        <div
            class="md:hidden fixed top-0 left-0 right-0 h-16 bg-slate-900 border-b border-slate-800 flex items-center justify-between px-4 z-40">
            <span class="font-bold text-xl text-white tracking-tight">
                Scale<span class="text-red-500">Marketing</span>
            </span>
            <button onclick="toggleSidebarMobile()" class="p-2 text-slate-400 hover:text-white">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </div>

        <!-- Mobile Sidebar Backdrop -->
        <div id="sidebar-backdrop" onclick="toggleSidebarMobile()"
            class="fixed inset-0 bg-slate-900/50 z-[45] hidden md:hidden backdrop-blur-sm transition-opacity">
        </div>

        <!-- Sidebar -->
        <aside
            class="fixed inset-y-0 left-0 z-50 w-64 bg-slate-900 text-white flex flex-col border-r border-slate-800 transition-transform duration-300 ease-in-out transform -translate-x-full md:translate-x-0 md:relative md:flex"
            id="sidebar">
            <!-- Header / Logo -->
            <div id="sidebar-header"
                class="h-16 flex items-center justify-between px-4 border-b border-slate-800 overflow-hidden transition-all duration-300">
                <span id="sidebar-logo"
                    class="font-bold text-xl tracking-tight whitespace-nowrap transition-all duration-300">
                    Scale<span class="text-red-500">Marketing</span>
                </span>
                <button onclick="toggleSidebar()"
                    class="p-1.5 rounded-lg hover:bg-slate-800 text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="chevron-left" id="sidebar-toggle-icon"
                        class="w-5 h-5 transition-transform duration-300"></i>
                </button>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 py-6 space-y-2 px-3">
                <!-- Parent Item: Growth -->
                <div>
                    <button onclick="toggleGrowthMenu()"
                        class="w-full flex items-center justify-between px-3 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group overflow-hidden whitespace-nowrap min-h-[44px]"
                        id="nav-growth-parent">
                        <div class="flex items-center">
                            <!-- Growth Icon -->
                            <i data-lucide="trending-up" class="w-5 h-5 min-w-[20px]"></i>
                            <span
                                class="font-medium text-sm ml-3 transition-opacity duration-300 opacity-100 sidebar-text">Growth</span>
                        </div>
                        <i data-lucide="chevron-down" id="growth-chevron"
                            class="w-4 h-4 transition-transform sidebar-text"></i>
                    </button>

                    <!-- Growth Submenu -->
                    <div id="growth-submenu" class="ml-4 mt-1 space-y-1 hidden border-l border-slate-700 pl-2">

                        <!-- Child: Dashboard (Moved inside Growth) -->
                        <div>
                            <button onclick="toggleDashboardMenu()"
                                class="w-full flex items-center justify-between px-3 py-2 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group overflow-hidden whitespace-nowrap"
                                id="nav-dashboard-parent">
                                <div class="flex items-center">
                                    <i data-lucide="layout-dashboard" class="w-4 h-4 min-w-[16px]"></i>
                                    <span
                                        class="font-medium text-sm ml-3 transition-opacity duration-300 opacity-100 sidebar-text">Dashboard</span>
                                </div>
                                <i data-lucide="chevron-down" id="dashboard-chevron"
                                    class="w-3.5 h-3.5 transition-transform sidebar-text"></i>
                            </button>

                            <!-- Dashboard Submenu (Level 2) -->
                            <div id="dashboard-submenu"
                                class="ml-4 mt-1 space-y-1 hidden border-l border-slate-700 pl-2">
                                <!-- Workshop Scale -->
                                <a href="#" onclick="navigateTo('dashboard'); setActiveSubItem(this)"
                                    class="flex items-center px-3 py-2 rounded-lg text-white text-sm transition-colors group">
                                    <span class="w-1.5 h-1.5 rounded-full bg-red-500 mr-2 transition-colors"></span>
                                    <span class="sidebar-text">Workshop Scale</span>
                                </a>

                                <!-- Scale Summit -->
                                <a href="#"
                                    class="flex items-center px-3 py-2 rounded-lg text-slate-500 cursor-default text-sm transition-colors group">
                                    <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-2 transition-colors"></span>
                                    <span class="sidebar-text">Scale Summit</span>
                                </a>

                                <!-- Program Scale -->
                                <a href="#"
                                    class="flex items-center px-3 py-2 rounded-lg text-slate-500 cursor-default text-sm transition-colors group">
                                    <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-2 transition-colors"></span>
                                    <span class="sidebar-text">Program Scale</span>
                                </a>

                                <!-- Scale Club -->
                                <a href="#"
                                    class="flex items-center px-3 py-2 rounded-lg text-slate-500 cursor-default text-sm transition-colors group">
                                    <span class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-2 transition-colors"></span>
                                    <span class="sidebar-text">Scale Club</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendas Link -->
                <a href="#" id="nav-vendas" onclick="navigateTo('vendas')"
                    class="flex items-center px-3 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group overflow-hidden whitespace-nowrap min-h-[44px]"
                    title="Vendas">
                    <i data-lucide="shopping-cart" class="w-5 h-5 min-w-[20px]"></i>
                    <span
                        class="font-medium text-sm ml-3 transition-opacity duration-300 opacity-100 sidebar-text">Vendas</span>
                </a>

                <!-- Automações Parent -->
                <div>
                    <button onclick="toggleAutomationsMenu()"
                        class="w-full flex items-center justify-between px-3 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group overflow-hidden whitespace-nowrap min-h-[44px]"
                        id="nav-automations-parent">
                        <div class="flex items-center">
                            <i data-lucide="bot" class="w-5 h-5 min-w-[20px]"></i>
                            <span
                                class="font-medium text-sm ml-3 transition-opacity duration-300 opacity-100 sidebar-text">Automações</span>
                        </div>
                        <i data-lucide="chevron-down" id="automations-chevron"
                            class="w-4 h-4 transition-transform sidebar-text"></i>
                    </button>

                    <!-- Submenu -->
                    <div id="automations-submenu" class="ml-4 mt-1 space-y-1 hidden border-l border-slate-700 pl-2">
                        <a href="#" onclick="navigateTo('whatsapp'); setActiveSubItem(this)"
                            class="flex items-center px-3 py-2 rounded-lg text-slate-500 hover:text-white text-sm transition-colors group">
                            <span
                                class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-2 transition-colors group-hover:bg-green-500"></span>
                            <span class="sidebar-text">WhatsApp</span>
                        </a>
                    </div>
                </div>

                <!-- Time Parent -->
                <div>
                    <button onclick="toggleTimeMenu()"
                        class="w-full flex items-center justify-between px-3 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group overflow-hidden whitespace-nowrap min-h-[44px]"
                        id="nav-time-parent">
                        <div class="flex items-center">
                            <i data-lucide="users" class="w-5 h-5 min-w-[20px]"></i>
                            <span
                                class="font-medium text-sm ml-3 transition-opacity duration-300 opacity-100 sidebar-text">Time</span>
                        </div>
                        <i data-lucide="chevron-down" id="time-chevron"
                            class="w-4 h-4 transition-transform sidebar-text"></i>
                    </button>

                    <!-- Submenu -->
                    <div id="time-submenu" class="ml-4 mt-1 space-y-1 hidden border-l border-slate-700 pl-2">
                        <a href="#" onclick="navigateTo('agents'); setActiveSubItem(this)"
                            class="flex items-center px-3 py-2 rounded-lg text-slate-500 hover:text-white text-sm transition-colors group">
                            <span
                                class="w-1.5 h-1.5 rounded-full bg-slate-700 mr-2 transition-colors group-hover:bg-red-500"></span>
                            <span class="sidebar-text">Agentes</span>
                        </a>
                    </div>
                </div>

                <a href="#" id="nav-settings" onclick="navigateTo('settings')"
                    class="flex items-center px-3 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-colors group overflow-hidden whitespace-nowrap min-h-[44px]"
                    title="Configurações">
                    <i data-lucide="settings" class="w-5 h-5 min-w-[20px]"></i>
                    <span
                        class="font-medium text-sm ml-3 transition-opacity duration-300 opacity-100 sidebar-text">Configurações</span>
                </a>
            </nav>

            <!-- Footer / Profile -->
            <div class="p-4 border-t border-slate-800 relative group" id="profile-footer">
                <!-- Dropup Menu -->
                <div id="profile-dropdown"
                    class="hidden absolute bottom-full left-4 bg-white rounded-lg shadow-xl border border-slate-200 w-56 mb-2 text-slate-700 overflow-hidden z-20">
                    <a href="#" class="flex items-center px-4 py-2 hover:bg-slate-50 text-sm transition-colors"
                        onclick="alert('Funcionalidade de Editar Perfil')">
                        <i data-lucide="user" class="w-4 h-4 mr-2 text-slate-400"></i>
                        Editar Perfil
                    </a>
                    <div class="border-t border-slate-100 my-1"></div>
                    <a href="#"
                        class="flex items-center px-4 py-2 hover:bg-red-50 text-red-600 text-sm transition-colors"
                        onclick="handleLogout()">
                        <i data-lucide="log-out" class="w-4 h-4 mr-2 text-red-500"></i>
                        Sair
                    </a>
                </div>

                <button onclick="toggleProfileMenu()"
                    class="flex items-center whitespace-nowrap w-full hover:bg-slate-800 rounded-lg p-2 -ml-2 transition-colors text-left outline-none focus:bg-slate-800">
                    <div
                        class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center border-2 border-slate-600 font-bold min-w-[40px]">
                        US</div>
                    <div class="ml-3 transition-opacity duration-300 opacity-100 sidebar-text" id="user-profile-info">
                        <p class="text-sm font-medium text-white">Admin User</p>
                        <p class="text-xs text-slate-500">admin@scale.com</p>
                    </div>
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col h-screen overflow-hidden bg-transparent relative pt-16 md:pt-0">
            <!-- Scrollable Area -->
            <div class="flex-1 overflow-y-auto p-8">
                <div class="max-w-7xl mx-auto space-y-8">

                    <!-- VIEW: DASHBOARD -->
                    <div id="view-dashboard" class="space-y-8 transition-opacity duration-300">
                        <!-- Header -->
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl font-bold text-slate-800">Dashboard de Vendas</h1>
                        </div>

                        <!-- Filters -->
                        <!-- Filters Toolbar -->
                        <div
                            class="flex flex-nowrap items-center gap-6 bg-white p-4 rounded-xl shadow-sm border border-slate-100 overflow-visible w-full">

                            <!-- 1. Date Picker (First) -->
                            <div class="relative shrink-0" id="datePickerContainer">
                                <button onclick="toggleDatePicker()"
                                    class="flex items-center px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hover:bg-slate-100 transition-colors whitespace-nowrap">
                                    <i data-lucide="calendar" class="w-4 h-4 mr-2 text-slate-500"></i>
                                    <span id="dateRangeLabel">Últimos 30 dias</span>
                                    <i data-lucide="chevron-down" class="w-3 h-3 ml-2 text-slate-400"></i>
                                </button>

                                <!-- Meta-style Date Picker Dropdown -->
                                <div id="datePickerDropdown"
                                    class="hidden absolute top-full left-0 mt-2 bg-white rounded-lg shadow-xl border border-slate-200 z-50 flex flex-col md:flex-row w-[90vw] md:w-[800px] max-h-[80vh] overflow-y-auto md:overflow-visible">

                                    <!-- Sidebar: Presets -->
                                    <div
                                        class="w-full md:w-64 border-b md:border-b-0 md:border-r border-slate-100 p-4 bg-slate-50/50 flex flex-row md:flex-col gap-2 md:gap-1 overflow-x-auto md:overflow-x-visible shrink-0">

                                        <!-- Mobile only title/helper -->
                                        <h4
                                            class="md:hidden text-xs font-semibold text-slate-500 mr-2 flex items-center shrink-0">
                                            PERÍODO:</h4>

                                        <h4
                                            class="hidden md:block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">
                                            Predefinições</h4>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Hoje
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Ontem
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Últimos 7 dias
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Últimos 14 dias
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 bg-blue-50 font-medium text-blue-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" checked />
                                            Últimos 30 dias
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Este mês
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Mês passado
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                            <input type="radio" name="datePreset"
                                                class="text-blue-600 focus:ring-blue-500" />
                                            Vitalício
                                        </label>
                                        <label
                                            class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap"
                                            id="preset-custom-container">
                                            <input type="radio" name="datePreset" id="preset-custom"
                                                class="text-blue-600 focus:ring-blue-500" disabled />
                                            Personalizado
                                        </label>
                                    </div>

                                    <!-- Main Area: Calendars -->
                                    <div class="flex-1 p-4 md:p-6">
                                        <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                            <!-- Inputs -->
                                            <div class="flex items-center gap-4">
                                                <div
                                                    class="border rounded px-3 py-1.5 text-sm w-32 text-center bg-slate-50">
                                                    25 dez 2025</div>
                                                <span class="text-slate-400">-</span>
                                                <div
                                                    class="border rounded px-3 py-1.5 text-sm w-32 text-center bg-slate-50">
                                                    25 jan 2026</div>
                                            </div>
                                        </div>

                                        <div class="flex flex-col md:flex-row gap-8">
                                            <!-- Calendar 1 -->
                                            <div class="flex-1">
                                                <div class="flex justify-between font-medium text-slate-700 mb-4 px-2">
                                                    <span>Dezembro 2025</span>
                                                </div>
                                                <div
                                                    class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                                                    <div>D</div>
                                                    <div>S</div>
                                                    <div>T</div>
                                                    <div>Q</div>
                                                    <div>Q</div>
                                                    <div>S</div>
                                                    <div>S</div>
                                                </div>
                                                <div class="grid grid-cols-7 gap-1 text-sm" id="cal-container-1">
                                                    <!-- JS Injected -->
                                                </div>
                                            </div>

                                            <!-- Calendar 2 -->
                                            <div class="flex-1">
                                                <div class="flex justify-between font-medium text-slate-700 mb-4 px-2">
                                                    <span>Janeiro 2026</span>
                                                </div>
                                                <div
                                                    class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                                                    <div>D</div>
                                                    <div>S</div>
                                                    <div>T</div>
                                                    <div>Q</div>
                                                    <div>Q</div>
                                                    <div>S</div>
                                                    <div>S</div>
                                                </div>
                                                <div class="grid grid-cols-7 gap-1 text-sm" id="cal-container-2">
                                                    <!-- JS Injected -->
                                                </div>
                                            </div>
                                        </div>

                                        <div
                                            class="flex justify-end items-center gap-3 mt-8 pt-4 border-t border-slate-100">
                                            <button onclick="toggleDatePicker()"
                                                class="px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium rounded">Cancelar</button>
                                            <button onclick="applyDateSelection()"
                                                class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded shadow-sm transition-colors">Atualizar</button>
                                        </div>
                                    </div>

                                </div>
                            </div>

                            <!-- 2. Account Selector (Second) -->
                            <div class="relative shrink-0" id="accountSelectorContainer">
                                <button onclick="toggleAccountDropdown()" id="accountSelectorBtn"
                                    class="flex items-center px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hover:bg-slate-100 transition-colors whitespace-nowrap">
                                    <div class="bg-blue-100 p-1 rounded-full mr-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
                                            <path
                                                d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
                                        </svg>
                                    </div>
                                    <span id="selectedAccountLabel" class="truncate max-w-[120px]">Selecionar
                                        Conta</span>
                                    <i data-lucide="chevron-down" class="w-3 h-3 ml-2 text-slate-400"></i>
                                </button>
                                <!-- Dropdown -->
                                <div id="accountDropdown"
                                    class="hidden absolute top-full left-0 mt-2 w-72 bg-white rounded-lg shadow-xl border border-slate-200 z-50 overflow-hidden">
                                    <div class="p-2 border-b border-slate-50 bg-slate-50/50">
                                        <span class="text-xs font-medium text-slate-500 uppercase">Contas
                                            Disponíveis</span>
                                    </div>
                                    <div id="accountListContainer" class="max-h-60 overflow-y-auto">
                                        <div class="px-3 py-2 text-xs text-slate-500 text-center">Conecte o Facebook na
                                            aba Configurações.</div>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. Campaign Filter (Third) -->
                            <div class="hidden relative shrink flex-1 min-w-[150px] max-w-md">
                                <div
                                    class="flex items-center px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hover:bg-slate-100 transition-colors cursor-pointer group w-full">
                                    <i data-lucide="filter" class="w-4 h-4 mr-2 text-slate-500 shrink-0"></i>
                                    <select id="campaign-select" onchange="updateSelectedCampaign(this.value)"
                                        class="bg-transparent border-none outline-none text-slate-700 text-sm font-medium appearance-none pr-6 cursor-pointer focus:ring-0 w-full truncate">
                                        <option value="all">Todas as campanhas</option>
                                    </select>
                                    <i data-lucide="chevron-down"
                                        class="w-3 h-3 ml-2 text-slate-400 absolute right-3 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- [NEW] Text Filter (Conditional) -->
                            <div class="relative shrink flex-1 min-w-[150px] max-w-xs">
                                <div
                                    class="flex items-center px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hover:bg-slate-100 transition-colors w-full focus-within:ring-2 focus-within:ring-blue-100 focus-within:border-blue-300">
                                    <button onclick="triggerTextSearch()"
                                        class="mr-2 text-slate-500 hover:text-blue-600 transition-colors shrink-0"
                                        title="Pesquisar">
                                        <i data-lucide="search" class="w-4 h-4"></i>
                                    </button>
                                    <input type="text" id="textFilterInput" placeholder="Nome da cidade..."
                                        class="bg-transparent border-none outline-none text-slate-700 text-sm w-full placeholder:text-slate-400"
                                        onkeydown="if(event.key === 'Enter') triggerTextSearch()">
                                </div>
                            </div>

                            <!-- 4. Product Filter (Fourth) -->
                            <div class="hidden relative shrink flex-1 min-w-[150px] max-w-sm">
                                <div
                                    class="flex items-center px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hover:bg-slate-100 transition-colors cursor-pointer group w-full">
                                    <i data-lucide="tag" class="w-4 h-4 mr-2 text-slate-500 shrink-0"></i>
                                    <select id="product-select" onchange="updateSelectedProduct(this.value)"
                                        class="bg-transparent border-none outline-none text-slate-700 text-sm font-medium appearance-none pr-6 cursor-pointer focus:ring-0 w-full truncate">
                                        <option value="all">Todos os produtos</option>
                                    </select>
                                    <i data-lucide="chevron-down"
                                        class="w-3 h-3 ml-2 text-slate-400 absolute right-3 pointer-events-none"></i>
                                </div>
                            </div>

                            <!-- 5. Refresh Button (Last) -->
                            <button onclick="handleManualRefresh()" id="btn-refresh-manual"
                                class="shrink-0 p-2 text-slate-400 hover:text-blue-600 hover:bg-slate-50 rounded-lg transition-colors"
                                title="Atualizar Dados">
                                <i data-lucide="rotate-cw" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <!-- KPI Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <!-- Card 1 -->
                            <div
                                class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-md group">
                                <div class="flex justify-between items-start mb-4">
                                    <div
                                        class="p-2 bg-slate-50 rounded-lg text-slate-500 group-hover:bg-blue-50 group-hover:text-blue-600 transition-colors">
                                        <i data-lucide="dollar-sign" class="w-5 h-5"></i>
                                    </div>
                                    <span id="trend-investment"
                                        class="bg-green-50 text-green-600 text-xs font-medium px-2 py-1 rounded-full flex items-center">+12%</span>
                                </div>
                                <p class="text-slate-500 text-sm font-medium">Investimento Total</p>
                                <h3 id="val-investment" class="text-2xl font-bold text-slate-900 mt-1">R$ 25.700,70</h3>
                            </div>

                            <!-- Card 2 (Highlight) -->
                            <div
                                class="bg-red-600 p-6 rounded-xl border border-red-500 shadow-sm text-white relative overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-red-200 hover:shadow-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div class="p-2 bg-red-500/50 rounded-lg text-white"><i data-lucide="trending-up"
                                            class="w-5 h-5"></i></div>
                                    <span id="trend-revenue"
                                        class="bg-white/20 text-white text-xs font-medium px-2 py-1 rounded-full flex items-center">+24%</span>
                                </div>
                                <p class="text-red-100 text-sm font-medium">Faturamento Total</p>
                                <h3 id="val-revenue" class="text-2xl font-bold mt-1">R$ 145.850,00</h3>
                            </div>

                            <!-- Card 3 -->
                            <div
                                class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-md group">
                                <div class="flex justify-between items-start mb-4">
                                    <div
                                        class="p-2 bg-slate-50 rounded-lg text-slate-500 group-hover:bg-purple-50 group-hover:text-purple-600 transition-colors">
                                        <i data-lucide="briefcase" class="w-5 h-5"></i>
                                    </div>
                                    <span id="trend-cpa"
                                        class="bg-red-50 text-red-600 text-xs font-medium px-2 py-1 rounded-full flex items-center">-5%</span>
                                </div>
                                <p class="text-slate-500 text-sm font-medium">CPA Médio</p>
                                <h3 id="val-cpa" class="text-2xl font-bold text-slate-900 mt-1">R$ 229,47</h3>
                            </div>

                            <!-- Card 4 -->
                            <div
                                class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm relative overflow-hidden transition-all duration-300 hover:-translate-y-1 hover:shadow-md group">
                                <div class="flex justify-between items-start mb-4">
                                    <div
                                        class="p-2 bg-slate-50 rounded-lg text-slate-500 group-hover:bg-emerald-50 group-hover:text-emerald-600 transition-colors">
                                        <i data-lucide="credit-card" class="w-5 h-5"></i>
                                    </div>
                                </div>
                                <p class="text-slate-500 text-sm font-medium">Ticket Médio</p>
                                <h3 id="val-ticket" class="text-2xl font-bold text-slate-900 mt-1">R$ 1.302,23</h3>
                            </div>
                        </div>

                        <!-- Secondary Stats -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div
                                class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md cursor-default">
                                <div class="p-2 bg-slate-50 rounded text-slate-500 mr-3"><i data-lucide="users"
                                        class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-slate-400">Participantes</p>
                                    <p id="val-parts" class="font-bold text-lg">112</p>
                                </div>
                            </div>
                            <div
                                class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md cursor-default">
                                <div class="p-2 bg-slate-50 rounded text-slate-500 mr-3"><i data-lucide="crown"
                                        class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-slate-400">VIPs</p>
                                    <p id="val-vips" class="font-bold text-lg">15</p>
                                </div>
                            </div>
                            <div
                                class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md cursor-default">
                                <div class="p-2 bg-slate-50 rounded text-slate-500 mr-3"><i data-lucide="ticket"
                                        class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-slate-400">Individuais</p>
                                    <p id="val-indiv" class="font-bold text-lg">70</p>
                                </div>
                            </div>
                            <div
                                class="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex items-center transition-all duration-300 hover:-translate-y-1 hover:shadow-md cursor-default">
                                <div class="p-2 bg-slate-50 rounded text-slate-500 mr-3"><i data-lucide="users-2"
                                        class="w-4 h-4"></i></div>
                                <div>
                                    <p class="text-xs text-slate-400">Duplos</p>
                                    <p id="val-double" class="font-bold text-lg">27</p>
                                </div>
                            </div>
                        </div>

                        <!-- Charts Placeholder -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm h-80 flex flex-col">
                                <h3 class="font-semibold text-slate-800 mb-4">Faturamento Acumulado</h3>
                                <div class="flex-1 flex items-end justify-between gap-2 px-2"
                                    id="revenue-chart-container">
                                    <!-- Chart Bars with Tooltips -->
                                    <div class="w-full bg-red-100 rounded-t transition-all duration-500 h-[20%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-0">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 18<br>R$ 12.500
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-red-100 rounded-t transition-all duration-500 h-[35%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-1">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 19<br>R$ 25.400
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-red-100 rounded-t transition-all duration-500 h-[50%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-2">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 20<br>R$ 45.100
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-red-200 rounded-t transition-all duration-500 h-[45%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-3">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 21<br>R$ 48.900
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-red-300 rounded-t transition-all duration-500 h-[60%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-4">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 22<br>R$ 85.000
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-red-500 rounded-t transition-all duration-500 h-[80%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-5">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 23<br>R$ 115.500
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-red-600 rounded-t transition-all duration-500 h-[75%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-rev-6">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 24<br>R$ 145.850
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-2 text-xs text-slate-400">
                                    <span id="chart-date-start">Jan 18</span><span id="chart-date-end">Jan 24</span>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm h-80 flex flex-col">
                                <h3 class="font-semibold text-slate-800 mb-4">Investimento Diário</h3>
                                <div class="flex-1 flex items-end justify-between gap-2 px-2"
                                    id="investment-chart-container">
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[40%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-0">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 18<br>R$ 850
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[30%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-1">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 19<br>R$ 720
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[50%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-2">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 20<br>R$ 1.200
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[45%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-3">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 21<br>R$ 950
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[60%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-4">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 22<br>R$ 1.500
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[70%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-5">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 23<br>R$ 1.800
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="w-full bg-slate-800 rounded-t transition-all duration-500 h-[65%] group relative hover:opacity-90 cursor-pointer"
                                        id="bar-inv-6">
                                        <div
                                            class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                            Jan 24<br>R$ 1.650
                                            <div
                                                class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-between mt-2 text-xs text-slate-400">
                                    <span id="chart-inv-start">Jan 18</span><span id="chart-inv-end">Jan 24</span>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden">
                            <div class="p-6 border-b border-slate-100 flex justify-between items-center">
                                <h3 class="font-semibold text-slate-800">Vendas Recentes</h3>
                                <button onclick="navigateTo('vendas')"
                                    class="text-sm text-red-600 font-medium hover:underline">Ver todas</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left text-sm text-slate-600">
                                    <thead class="bg-slate-50 text-slate-700 font-semibold uppercase text-xs">
                                        <tr>
                                            <th class="px-6 py-4">Data</th>
                                            <th class="px-6 py-4">Cliente</th>
                                            <th class="px-6 py-4">Produto</th>
                                            <th class="px-6 py-4">Pagamento</th>
                                            <th class="px-6 py-4">Plataforma</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4 text-right">Valor</th>
                                        </tr>
                                    </thead>
                                    <tbody id="recent-sales-body" class="divide-y divide-slate-100">
                                        <!-- JS Injected -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>



                    <!-- VIEW: AGENTS (Restored) -->
                    <div id="view-agents" class="space-y-8 hidden transition-opacity duration-300">
                        <!-- Header -->
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-3 mb-1">
                                    <i data-lucide="bot" class="w-8 h-8 text-slate-800"></i>
                                    <h1 class="text-2xl font-bold text-slate-800">Organograma de Agentes</h1>
                                </div>
                                <p class="text-slate-500">Gerencie a hierarquia e fluxo de trabalho entre agentes de IA
                                </p>
                            </div>
                            <button onclick="openAgentModal()"
                                class="px-4 py-2 bg-orange-500 hover:bg-orange-600 text-white font-medium rounded-lg transition-colors flex items-center shadow-lg shadow-orange-500/20">
                                <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                Novo Agente
                            </button>
                        </div>

                        <!-- Stats Cards -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                                <div class="text-3xl font-bold text-slate-800 mb-1">6</div>
                                <div class="text-sm text-slate-500 font-medium">Total de Agentes</div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                                <div class="text-3xl font-bold text-green-600 mb-1">6</div>
                                <div class="text-sm text-slate-500 font-medium">Agentes Ativos</div>
                            </div>
                            <div class="bg-white p-6 rounded-xl border border-slate-100 shadow-sm">
                                <div class="text-3xl font-bold text-orange-500 mb-1">0</div>
                                <div class="text-sm text-slate-500 font-medium">Agentes Inativos</div>
                            </div>
                        </div>

                        <!-- Organogram Canvas Container -->
                        <div id="organogram-container"
                            class="w-full h-[600px] relative cursor-grab overflow-hidden active:cursor-grabbing border bg-slate-50 rounded-xl flex items-center justify-center"
                            onmousedown="handleGlobalMouseDown(event)" onmousemove="handleGlobalMouseMove(event)"
                            onmouseup="handleGlobalMouseUp(event)">

                            <!-- Dot Pattern Background -->
                            <div class="absolute inset-0 pointer-events-none opacity-30 pattern-dots"
                                style="background-image: radial-gradient(#cbd5e1 1px, transparent 1px); background-size: 20px 20px;">
                            </div>

                            <!-- Content Layer (Pan/Zoom Target) -->
                            <div id="organogram-content"
                                class="absolute inset-0 origin-top-left transition-transform duration-75 ease-out select-none"
                                style="width: 100%; height: 100%;">

                                <!-- SVG Connections Layer -->
                                <svg id="connections-layer"
                                    class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-visible"
                                    style="z-index: 0;">
                                    <!-- Dynamic lines will be drawn here -->
                                </svg>

                                <!-- Agent 0: CEO (Root) -->
                                <div id="card-ceo" class="absolute z-10 w-72 group" style="left: 0px; top: -200px;">
                                    <div class="conn-hit-area bottom-point connection-dot-out"
                                        onmousedown="handleDotMouseDown(event, 'card-ceo')">
                                        <div class="conn-dot"></div>
                                    </div>

                                    <div
                                        class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
                                        <div class="flex items-start gap-3">
                                            <div
                                                class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                                                <i data-lucide="bot" class="w-4 h-4 text-orange-600"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-1 gap-2">
                                                    <h3 class="font-bold text-slate-800 text-sm truncate"
                                                        data-field="name">CEO</h3>
                                                    <span
                                                        class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">ATIVO</span>
                                                </div>
                                                <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3"
                                                    data-field="desc">Assistente executivo que gerencia estratégia,
                                                    metas, projetos e equipe</p>
                                                <div class="flex gap-1 mb-1 flex-wrap">
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="provider">anthropic</span>
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="model">claude-3-5-sonnet-20240620</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                                            <button onclick="previewAgent('card-ceo')"
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"><i
                                                    data-lucide="eye" class="w-3 h-3"></i></button>
                                            <button onclick="editAgent('card-ceo')"
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"><i
                                                    data-lucide="settings" class="w-3 h-3"></i></button>
                                            <button onclick="deleteAgent('card-ceo')"
                                                class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i
                                                    data-lucide="trash-2" class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Agent 1: Traffic -->
                                <div id="card-traffic" class="absolute z-10 w-72 group"
                                    style="left: -500px; top: 100px;">
                                    <div class="conn-hit-area top-point connection-dot-in">
                                        <div class="conn-dot"></div>
                                    </div>
                                    <div class="conn-hit-area bottom-point connection-dot-out"
                                        onmousedown="handleDotMouseDown(event, 'card-traffic')">
                                        <div class="conn-dot"></div>
                                    </div>

                                    <div
                                        class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
                                        <div class="flex items-start gap-3">
                                            <div
                                                class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                                                <i data-lucide="bar-chart-3" class="w-4 h-4 text-orange-600"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-1 gap-2">
                                                    <h3 class="font-bold text-slate-800 text-sm truncate"
                                                        data-field="name">
                                                        Gestor de Tráfego</h3>
                                                    <span
                                                        class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">Ativo</span>
                                                </div>
                                                <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3"
                                                    data-field="desc">Especialista em Meta Ads com acesso direto à API
                                                </p>
                                                <div class="flex gap-1 mb-1 flex-wrap">
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="provider">anthropic</span>
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="model">claude</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="previewAgent('card-traffic')"><i data-lucide="eye"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="editAgent('card-traffic')"><i data-lucide="settings"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="deleteAgent('card-traffic')"><i data-lucide="trash-2"
                                                    class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Agent 2: Copy -->
                                <div id="card-copy" class="absolute z-10 w-72 group" style="left: -170px; top: 100px;">
                                    <div class="conn-hit-area top-point connection-dot-in">
                                        <div class="conn-dot"></div>
                                    </div>
                                    <div class="conn-hit-area bottom-point connection-dot-out"
                                        onmousedown="handleDotMouseDown(event, 'card-copy')">
                                        <div class="conn-dot"></div>
                                    </div>

                                    <div
                                        class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
                                        <div class="flex items-start gap-3">
                                            <div
                                                class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                                                <i data-lucide="pen-tool" class="w-4 h-4 text-orange-600"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-1 gap-2">
                                                    <h3 class="font-bold text-slate-800 text-sm truncate"
                                                        data-field="name">
                                                        Agente Copy</h3>
                                                    <span
                                                        class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">Ativo</span>
                                                </div>
                                                <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3"
                                                    data-field="desc">Criação de textos persuasivos e scripts de vendas
                                                </p>
                                                <div class="flex gap-1 mb-1 flex-wrap">
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="provider">anthropic</span>
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="model">claude</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="previewAgent('card-copy')"><i data-lucide="eye"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="editAgent('card-copy')"><i data-lucide="settings"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="deleteAgent('card-copy')"><i data-lucide="trash-2"
                                                    class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Agent 3: Content -->
                                <div id="card-content" class="absolute z-10 w-72 group"
                                    style="left: 170px; top: 100px;">
                                    <div class="conn-hit-area top-point connection-dot-in">
                                        <div class="conn-dot"></div>
                                    </div>
                                    <div class="conn-hit-area bottom-point connection-dot-out"
                                        onmousedown="handleDotMouseDown(event, 'card-content')">
                                        <div class="conn-dot"></div>
                                    </div>

                                    <div
                                        class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
                                        <div class="flex items-start gap-3">
                                            <div
                                                class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                                                <i data-lucide="file-text" class="w-4 h-4 text-orange-600"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-1 gap-2">
                                                    <h3 class="font-bold text-slate-800 text-sm truncate"
                                                        data-field="name">
                                                        Agente de Conteúdo</h3>
                                                    <span
                                                        class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">Ativo</span>
                                                </div>
                                                <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3"
                                                    data-field="desc">Gera conteúdo para redes sociais e blog</p>
                                                <div class="flex gap-1 mb-1 flex-wrap">
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="provider">anthropic</span>
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="model">claude</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="previewAgent('card-content')"><i data-lucide="eye"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="editAgent('card-content')"><i data-lucide="settings"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="deleteAgent('card-content')"><i data-lucide="trash-2"
                                                    class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Agent 4: Sales -->
                                <div id="card-sales" class="absolute z-10 w-72 group" style="left: 500px; top: 100px;">
                                    <div class="conn-hit-area top-point connection-dot-in">
                                        <div class="conn-dot"></div>
                                    </div>
                                    <div class="conn-hit-area bottom-point connection-dot-out"
                                        onmousedown="handleDotMouseDown(event, 'card-sales')">
                                        <div class="conn-dot"></div>
                                    </div>

                                    <div
                                        class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
                                        <div class="flex items-start gap-3">
                                            <div
                                                class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                                                <i data-lucide="message-circle" class="w-4 h-4 text-orange-600"></i>
                                            </div>
                                            <div class="flex-1 min-w-0">
                                                <div class="flex items-center justify-between mb-1 gap-2">
                                                    <h3 class="font-bold text-slate-800 text-sm truncate"
                                                        data-field="name">
                                                        Agente de Vendas</h3>
                                                    <span
                                                        class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">Ativo</span>
                                                </div>
                                                <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3"
                                                    data-field="desc">Realiza atendimento humano e fechamento</p>
                                                <div class="flex gap-1 mb-1 flex-wrap">
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="provider">anthropic</span>
                                                    <span
                                                        class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded"
                                                        data-field="model">claude</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="previewAgent('card-sales')"><i data-lucide="eye"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="editAgent('card-sales')"><i data-lucide="settings"
                                                    class="w-3 h-3"></i></button>
                                            <button
                                                class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"
                                                onclick="deleteAgent('card-sales')"><i data-lucide="trash-2"
                                                    class="w-3 h-3"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Zoom Controls -->
                            <div
                                class="absolute bottom-4 left-4 bg-white rounded-lg shadow border border-slate-200 flex flex-col p-1 z-50">
                                <button onclick="zoomOrganogram(0.1)"
                                    class="p-2 hover:bg-slate-100 text-slate-500 rounded tooltip"
                                    title="Aumentar Zoom"><i data-lucide="plus" class="w-4 h-4"></i></button>
                                <button onclick="zoomOrganogram(-0.1)"
                                    class="p-2 hover:bg-slate-100 text-slate-500 rounded tooltip"
                                    title="Diminuir Zoom"><i data-lucide="minus" class="w-4 h-4"></i></button>
                                <button onclick="fitOrganogram()"
                                    class="p-2 hover:bg-slate-100 text-slate-500 rounded tooltip"
                                    title="Centralizar Tudoz"><i data-lucide="maximize" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: VENDAS (New) -->
                    <div id="view-vendas" class="space-y-8 hidden transition-opacity duration-300">
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl font-bold text-slate-800">Vendas</h1>
                            <div class="flex gap-4">
                                <!-- Sales Date Picker Container -->
                                <div class="relative" id="salesDatePickerContainer">
                                    <button onclick="toggleSalesDatePicker()"
                                        class="flex items-center px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-slate-700 hover:bg-slate-100 transition-colors">
                                        <i data-lucide="calendar" class="w-4 h-4 mr-2 text-slate-500"></i>
                                        <span id="salesDateRangeLabel">Últimos 30 dias</span>
                                        <i data-lucide="chevron-down" class="w-3 h-3 ml-2 text-slate-400"></i>
                                    </button>

                                    <!-- Meta-style Date Picker Dropdown -->
                                    <div id="salesDatePickerDropdown"
                                        class="hidden absolute top-full right-0 mt-2 bg-white rounded-lg shadow-xl border border-slate-200 z-50 flex flex-col md:flex-row w-[90vw] md:w-[800px] max-h-[80vh] overflow-y-auto md:overflow-visible">

                                        <!-- Sidebar: Presets -->
                                        <div
                                            class="w-full md:w-64 border-b md:border-b-0 md:border-r border-slate-100 p-4 bg-slate-50/50 flex flex-row md:flex-col gap-2 md:gap-1 overflow-x-auto md:overflow-x-visible shrink-0">

                                            <!-- Mobile only title/helper -->
                                            <h4
                                                class="md:hidden text-xs font-semibold text-slate-500 mr-2 flex items-center shrink-0">
                                                PERÍODO:</h4>

                                            <h4
                                                class="hidden md:block text-xs font-semibold text-slate-500 mb-2 uppercase tracking-wider">
                                                Predefinições</h4>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Hoje
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Ontem
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Últimos 7 dias
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Últimos 14 dias
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 bg-blue-50 font-medium text-blue-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" checked /> Últimos 30
                                                dias
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Este mês
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Mês passado
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap">
                                                <input type="radio" name="salesDatePreset"
                                                    class="text-blue-600 focus:ring-blue-500" /> Vitalício
                                            </label>
                                            <label
                                                class="flex items-center gap-3 p-2 rounded hover:bg-slate-100 cursor-pointer text-sm text-slate-700 whitespace-nowrap"
                                                id="sales-preset-custom-container">
                                                <input type="radio" name="salesDatePreset" id="sales-preset-custom"
                                                    class="text-blue-600 focus:ring-blue-500" disabled />
                                                Personalizado
                                            </label>
                                        </div>

                                        <!-- Main Area: Calendars -->
                                        <div class="flex-1 p-4 md:p-6">
                                            <div
                                                class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                                <div class="flex items-center gap-4">
                                                    <div class="border rounded px-3 py-1.5 text-sm w-32 text-center bg-slate-50"
                                                        id="sales-input-start">-</div>
                                                    <span class="text-slate-400">-</span>
                                                    <div class="border rounded px-3 py-1.5 text-sm w-32 text-center bg-slate-50"
                                                        id="sales-input-end">-</div>
                                                </div>
                                            </div>

                                            <div class="flex flex-col md:flex-row gap-8">
                                                <!-- Calendar 1 -->
                                                <div class="flex-1">
                                                    <div
                                                        class="flex justify-between font-medium text-slate-700 mb-4 px-2">
                                                        <button onclick="changeSalesMonth(-1)"
                                                            class="p-1 hover:bg-slate-100 rounded">
                                                            << /button>
                                                                <span id="sales-cal-title-1"></span>
                                                                <span></span>
                                                    </div>
                                                    <div
                                                        class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                                                        <div>D</div>
                                                        <div>S</div>
                                                        <div>T</div>
                                                        <div>Q</div>
                                                        <div>Q</div>
                                                        <div>S</div>
                                                        <div>S</div>
                                                    </div>
                                                    <div class="grid grid-cols-7 gap-1 text-sm"
                                                        id="sales-cal-container-1">
                                                    </div>
                                                </div>

                                                <!-- Calendar 2 -->
                                                <div class="flex-1">
                                                    <div
                                                        class="flex justify-between font-medium text-slate-700 mb-4 px-2">
                                                        <span id="sales-cal-title-2"></span>
                                                        <button onclick="changeSalesMonth(1)"
                                                            class="p-1 hover:bg-slate-100 rounded">></button>
                                                    </div>
                                                    <div
                                                        class="grid grid-cols-7 gap-1 text-center text-xs text-slate-400 mb-2">
                                                        <div>D</div>
                                                        <div>S</div>
                                                        <div>T</div>
                                                        <div>Q</div>
                                                        <div>Q</div>
                                                        <div>S</div>
                                                        <div>S</div>
                                                    </div>
                                                    <div class="grid grid-cols-7 gap-1 text-sm"
                                                        id="sales-cal-container-2">
                                                    </div>
                                                </div>
                                            </div>

                                            <div
                                                class="flex justify-end items-center gap-3 mt-8 pt-4 border-t border-slate-100">
                                                <button onclick="toggleSalesDatePicker()"
                                                    class="px-4 py-2 text-slate-600 hover:bg-slate-50 text-sm font-medium rounded">Cancelar</button>
                                                <button onclick="applySalesDateSelection()"
                                                    class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded shadow-sm transition-colors">Atualizar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="navigateTo('dashboard')"
                                    class="text-sm text-slate-500 hover:text-slate-900 border border-slate-200 px-3 py-2 rounded-lg bg-white">Voltar</button>
                            </div>
                        </div>

                        <!-- Full Sales Table -->
                        <div class="bg-white rounded-xl border border-slate-100 shadow-sm overflow-hidden relative">
                            <div class="p-6 border-b border-slate-100 flex gap-4 flex-wrap">
                                <div class="relative">
                                    <i data-lucide="search"
                                        class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                                    <input type="text" id="sales-search" onkeyup="renderSalesTable()"
                                        placeholder="Buscar por cliente, email..."
                                        class="pl-10 bg-slate-50 border border-slate-200 text-sm rounded-lg pr-4 py-2 w-64 outline-none focus:border-red-500 focus:ring-1 focus:ring-red-200 transition-all">
                                </div>
                                <select id="sales-status-filter" onchange="renderSalesTable()"
                                    class="bg-slate-50 border border-slate-200 text-sm rounded-lg px-4 py-2 outline-none cursor-pointer focus:border-red-500 focus:ring-1 focus:ring-red-200 transition-all">
                                    <option value="all">Status: Todos</option>
                                    <option value="Aprovado">Aprovado</option>
                                    <option value="Pendente">Pendente</option>
                                    <option value="Recusado">Recusado</option>
                                </select>
                            </div>
                            <div class="overflow-x-auto relative">
                                <table class="w-full text-left text-sm text-slate-600">
                                    <thead class="bg-slate-50 text-slate-700 font-semibold uppercase text-xs">
                                        <tr>
                                            <th class="px-6 py-4">Data</th>
                                            <th class="px-6 py-4">Cliente</th>
                                            <th class="px-6 py-4">Produto</th>
                                            <th class="px-6 py-4">Pagamento</th>
                                            <th class="px-6 py-4">Status</th>
                                            <th class="px-6 py-4 text-right">Valor</th>
                                            <th class="px-6 py-4 text-center">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sales-table-body" class="divide-y divide-slate-100">
                                        <!-- JS Injected -->
                                    </tbody>
                                </table>
                                </table>
                            </div>
                            <!-- Pagination -->
                            <div
                                class="p-4 border-t border-slate-100 flex justify-between items-center text-sm text-slate-500">
                                <span id="sales-pagination-info">Mostrando 0 de 0 resultados</span>
                                <div class="flex items-center gap-6">
                                    <div class="flex items-center gap-2 text-xs">
                                        <span>Linhas por página:</span>
                                        <select id="sales-page-size" onchange="changeSalesPageSize(this.value)"
                                            class="border border-slate-200 rounded px-2 py-1 bg-white outline-none focus:ring-1 focus:ring-red-200 cursor-pointer">
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                            <option value="100">100</option>
                                        </select>
                                    </div>
                                    <div class="flex gap-2">
                                        <button id="sales-prev-btn" onclick="changeSalesPage(-1)"
                                            class="px-3 py-1 border rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                                            disabled>Anterior</button>
                                        <button id="sales-next-btn" onclick="changeSalesPage(1)"
                                            class="px-3 py-1 border rounded hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer"
                                            disabled>Próxima</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Loading Overlay -->
                        <div id="table-loading-overlay"
                            class="absolute inset-0 bg-white/80 backdrop-blur-[1px] hidden flex-col items-center justify-center z-50 transition-all duration-300 rounded-xl">
                            <div
                                class="bg-white p-4 rounded-xl shadow-lg border border-slate-100 flex flex-col items-center animate-in fade-in zoom-in duration-300">
                                <i data-lucide="loader-2" class="w-8 h-8 text-indigo-600 animate-spin mb-3"></i>
                                <span class="text-sm font-medium text-slate-700">Carregando...</span>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: WHATSAPP -->
                    <div id="view-whatsapp" class="hidden animate-in fade-in duration-300">
                        <div class="p-6 max-w-7xl mx-auto">
                            <!-- Header -->
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                                <div>
                                    <h1 class="text-2xl font-bold text-slate-800">WhatsApp</h1>
                                    <p class="text-sm text-slate-500">Integração UAZAPI (Beta)</p>
                                </div>
                                <button id="btn-new-instance" onclick="openNewInstanceModal()"
                                    class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-2.5 rounded-lg flex items-center shadow-md font-medium text-sm transition-transform active:scale-95">
                                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                                    Nova Instância
                                </button>
                            </div>

                            <!-- List Container -->
                            <!-- Tabs Header -->
                            <div class="border-b border-slate-200 mb-6">
                                <div class="flex gap-6">
                                    <button onclick="switchWaTab('instances')" id="tab-btn-instances"
                                        class="pb-3 border-b-2 border-orange-500 text-orange-600 font-medium text-sm transition-colors">
                                        Instâncias <span id="count-instances"
                                            class="ml-1 bg-orange-100 text-orange-700 py-0.5 px-2 rounded-full text-xs">0</span>
                                    </button>
                                    <button onclick="switchWaTab('groups')" id="tab-btn-groups"
                                        class="pb-3 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium text-sm transition-colors">
                                        Grupos <span
                                            class="ml-1 bg-slate-100 text-slate-600 py-0.5 px-2 rounded-full text-xs">0</span>
                                    </button>
                                    <button onclick="switchWaTab('alerts')" id="tab-btn-alerts"
                                        class="pb-3 border-b-2 border-transparent text-slate-500 hover:text-slate-700 font-medium text-sm transition-colors">
                                        Alertas
                                    </button>
                                </div>
                            </div>

                            <!-- Tab Content: Instances -->
                            <div id="tab-content-instances" class="wa-tab-content animate-in fade-in duration-300">
                                <div id="instance-list-container"
                                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Rendered dynamically -->
                                    <div
                                        class="col-span-full text-center py-12 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                                        <p class="text-slate-500">Nenhuma instância conectada.</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Tab Content: Groups (Placeholder) -->
                            <div id="tab-content-groups" class="wa-tab-content hidden animate-in fade-in duration-300">
                                <div
                                    class="text-center py-12 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                                    <p class="text-slate-500">Nenhum grupo sincronizado.</p>
                                </div>
                            </div>

                            <!-- Tab Content: Alerts (Placeholder) -->
                            <div id="tab-content-alerts" class="wa-tab-content hidden animate-in fade-in duration-300">
                                <div
                                    class="text-center py-12 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                                    <p class="text-slate-500">Nenhum alerta configurado.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIEW: SETTINGS (Initially Hidden) -->
                    <div id="view-settings" class="space-y-8 hidden transition-opacity duration-300">
                        <div class="flex items-center justify-between">
                            <h1 class="text-2xl font-bold text-slate-800">Configurações</h1>
                            <button onclick="navigateTo('dashboard')"
                                class="text-sm text-slate-500 hover:text-slate-900">Voltar para Dashboard</button>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                            <div class="p-6 border-b border-slate-100">
                                <h2 class="text-lg font-semibold text-slate-800">Integrações</h2>
                                <p class="text-sm text-slate-500 mt-1">Conecte suas contas para sincronizar dados
                                    automaticamente.</p>
                            </div>

                            <div class="p-6 space-y-6">
                                <!-- Facebook Ads -->
                                <div
                                    class="flex items-start gap-4 p-4 border border-slate-200 rounded-lg hover:border-slate-300 transition-colors">
                                    <div
                                        class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center text-blue-600 shrink-0">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                            stroke-linecap="round" stroke-linejoin="round"
                                            class="lucide lucide-facebook">
                                            <path
                                                d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z" />
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-1">
                                            <h3 class="font-medium text-slate-900">Facebook & Instagram Ads</h3>
                                            <span
                                                class="text-xs font-medium bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full"
                                                id="status-fb">Desconectado</span>
                                        </div>
                                        <p class="text-sm text-slate-500 mb-3">Conecte sua conta de anúncios para
                                            importar
                                            dados de impressões, cliques e custos (CPA/CPC).</p>
                                        <button id="btn-connect-fb" onclick="connectIntegration('fb')"
                                            class="text-sm font-medium px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">Conectar
                                            Conta</button>
                                    </div>
                                </div>

                                <!-- GoExplosion (Mock Platform) -->
                                <div
                                    class="flex items-start gap-4 p-4 border border-slate-200 rounded-lg hover:border-slate-300 transition-colors">
                                    <div
                                        class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center text-purple-600 shrink-0">
                                        <i data-lucide="zap" class="w-6 h-6"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-1">
                                            <h3 class="font-medium text-slate-900">Webhook de Integração</h3>
                                            <span
                                                class="text-xs font-medium bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full hidden"
                                                id="status-go">Ativo</span>
                                        </div>
                                        <p class="text-sm text-slate-500 mb-3">Integre com sua plataforma de
                                            pagamentos
                                            para
                                            receber seus dados de vendas em tempo real via Webhook.</p>

                                        <div id="go-connect-form" class="space-y-3">
                                            <div class="flex flex-col gap-1">
                                                <span class="text-xs font-medium text-slate-500">Sua URL de
                                                    Webhook:</span>
                                                <div class="flex gap-2">
                                                    <div class="relative flex-1 group">
                                                        <input type="text" id="webhook-url"
                                                            value="https://bqlhtbzgsmpqqtyihizt.supabase.co/functions/v1/goexplosion-webhook"
                                                            readonly
                                                            class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm bg-slate-50 text-slate-600 focus:outline-none font-mono cursor-pointer selection:bg-blue-100"
                                                            onclick="copyWebhookUrl()">
                                                    </div>
                                                    <button onclick="copyWebhookUrl()"
                                                        class="text-sm font-medium px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors whitespace-nowrap shadow-sm flex items-center gap-2">
                                                        <i data-lucide="copy" class="w-4 h-4"></i> Copiar Link
                                                    </button>
                                                </div>
                                                <p class="text-xs text-slate-400">Configure esta URL nas
                                                    configurações
                                                    de Webhook da sua plataforma (GoExplosion, Kiwify, Etc).</p>
                                            </div>
                                        </div>

                                        <div id="go-connected-msg"
                                            class="hidden text-sm text-slate-600 bg-emerald-50 border border-emerald-100 rounded-lg p-3">
                                            <!-- Injected via JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- LLM Keys -->
                                <div
                                    class="flex items-start gap-4 p-4 border border-slate-200 rounded-lg hover:border-slate-300 transition-colors">
                                    <div
                                        class="w-12 h-12 bg-indigo-50 rounded-lg flex items-center justify-center text-indigo-600 shrink-0">
                                        <i data-lucide="key" class="w-6 h-6"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between mb-1">
                                            <h3 class="font-medium text-slate-900">Provedores de IA</h3>
                                            <span
                                                class="text-xs font-medium bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full">Opcional</span>
                                        </div>
                                        <p class="text-sm text-slate-500 mb-4">Configure chaves de API para permitir que
                                            agentes utilizem diferentes modelos.</p>

                                        <div class="space-y-4">
                                            <div>
                                                <label
                                                    class="block text-xs font-semibold text-slate-500 uppercase mb-1">OpenAI
                                                    API Key</label>
                                                <input type="password" placeholder="sk-..."
                                                    class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-xs font-semibold text-slate-500 uppercase mb-1">Anthropic
                                                    API Key</label>
                                                <input type="password" placeholder="sk-ant-..."
                                                    class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-xs font-semibold text-slate-500 uppercase mb-1">Google
                                                    AI Key</label>
                                                <input type="password" placeholder="AIzam..."
                                                    class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono">
                                            </div>
                                            <div class="flex justify-end pt-2">
                                                <button
                                                    class="text-xs font-medium text-emerald-600 hover:text-emerald-700 flex items-center">
                                                    <i data-lucide="check" class="w-3 h-3 mr-1"></i> Salvar Chaves
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>


    </div> <!-- End App Container -->

    <!-- New Agent Modal -->
    <div id="agent-modal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all scale-95 opacity-0 duration-300"
            id="agent-modal-content">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Editar Agente</h3>
                    <p class="text-xs text-slate-500 mt-1">Atualize as configurações do agente de IA</p>
                </div>
                <button onclick="closeAgentModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                <!-- Name -->
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Nome</label>
                    <input type="text" id="agent-name" placeholder="Ex: Gestor de Tráfego"
                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all">
                </div>

                <!-- Slug -->
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Slug (identificador
                        único)</label>
                    <input type="text" id="agent-slug" placeholder="Ex: traffic"
                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono text-slate-600 focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all">
                </div>

                <!-- Description -->
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Descrição</label>
                    <textarea id="agent-desc" rows="2" placeholder="Ex: Agente especialista em Meta Ads..."
                        class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Provider -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Provider</label>
                        <select id="agent-provider" onchange="updateModelOptions()"
                            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all cursor-pointer appearance-none">
                            <option value="openai">OpenAI</option>
                            <option value="anthropic">Anthropic</option>
                            <option value="google">Google</option>
                        </select>
                    </div>
                    <!-- Model -->
                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">Modelo</label>
                        <select id="agent-model"
                            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all cursor-pointer appearance-none">
                            <!-- Populated via JS -->
                        </select>
                    </div>
                </div>

                <!-- Prompt -->
                <div>
                    <label class="block text-xs font-semibold text-slate-500 uppercase mb-1">System Prompt</label>
                    <div class="relative">
                        <textarea id="agent-prompt" rows="6"
                            placeholder="Defina a personalidade e instruções do agente..."
                            class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-mono text-xs focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all resize-y"></textarea>
                        <div class="absolute bottom-2 right-2 flex gap-1">
                            <button class="p-1 bg-white border border-slate-200 rounded hover:bg-slate-50"
                                title="Expandir" type="button"><i data-lucide="maximize-2"
                                    class="w-3 h-3 text-slate-400"></i></button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-t border-slate-100 flex justify-end gap-3 bg-slate-50 rounded-b-xl">
                <button onclick="closeAgentModal()"
                    class="px-4 py-2 text-slate-600 hover:text-slate-800 text-sm font-medium transition-colors">Cancelar</button>
                <button onclick="saveAgent()"
                    class="px-6 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg shadow-lg shadow-orange-500/20 transition-all transform active:scale-95">Salvar
                    Alterações</button>
            </div>
        </div>
    </div>

    <!-- WhatsApp Instance Modal -->
    <div id="instance-modal"
        class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all scale-95 opacity-0 duration-300"
            id="instance-modal-content">
            <!-- Header -->
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">Nova Instância</h3>
                    <p class="text-xs text-slate-500 mt-1">Conecte um novo número de WhatsApp</p>
                </div>
                <button onclick="closeNewInstanceModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <!-- Content -->
            <div class="p-6 flex flex-col items-center justify-center space-y-6" id="qr-content-wrapper">

                <!-- Step 1: Input Name & Token -->
                <div id="step-name" class="w-full">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nome da Instância</label>
                    <input type="text" id="wa-name-input" class="w-full p-2 border border-slate-200 rounded-lg mb-4"
                        placeholder="Ex: Loja Principal">

                    <label class="block text-sm font-medium text-slate-700 mb-1">
                        Token da Instância (Opcional)
                        <span class="block text-xs text-slate-400 font-normal">Pegue no painel da UAZAPI. Se usar este
                            token, a conexão é direta.</span>
                    </label>
                    <input type="text" id="new-instance-token"
                        class="w-full p-2 border border-slate-200 rounded-lg text-sm font-mono mb-4"
                        placeholder="Ex: 7a78c87b-...">

                    <div class="flex justify-end space-x-2 mt-2">
                        <button onclick="closeNewInstanceModal()"
                            class="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg">Cancelar</button>
                        <button onclick="initRealConnection()"
                            class="px-4 py-2 bg-gradient-to-r from-orange-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                            Gerar QR Code
                        </button>
                    </div>
                </div>

                <!-- QR Loading State -->
                <div id="qr-loading" class="hidden flex flex-col items-center">
                    <div
                        class="w-12 h-12 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin mb-3">
                    </div>
                    <p class="text-sm font-medium text-slate-600">Conectando à API...</p>
                    <p class="text-xs text-slate-400 mt-1">Isso pode levar alguns segundos</p>
                </div>

                <!-- QR Display State -->
                <div id="qr-display" class="hidden w-full flex flex-col items-center">
                    <div class="w-48 h-48 bg-white p-2 rounded-lg border-2 border-slate-100 shadow-sm relative overflow-hidden"
                        id="qr-image-container">
                        <img id="qr-code-img" class="w-full h-full object-contain" src="" alt="QR Code" />
                    </div>
                    <div class="mt-4 text-center">
                        <p class="text-sm font-medium text-slate-800 mb-1">Abra o WhatsApp e escaneie</p>
                        <p class="text-xs text-slate-500 mb-3">Menu > Aparelhos conectados > Conectar um aparelho</p>
                        <button
                            onclick="finalizeConnection(document.getElementById('wa-name-input').value, document.getElementById('new-instance-token').value)"
                            class="px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium rounded-lg transition-colors">
                            Já Escaneiei / Concluir
                        </button>
                    </div>
                </div>

                <!-- QR Expired/Error State -->
                <div id="qr-expired" class="hidden flex flex-col items-center text-center">
                    <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mb-3">
                        <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
                    </div>
                    <h3 class="font-medium text-slate-800 mb-1">Erro na Conexão</h3>
                    <p class="text-sm text-slate-500 mb-4" id="qr-error-msg">Ocorreu um erro ao gerar o QR Code.</p>
                    <button onclick="openNewInstanceModal()"
                        class="text-sm text-orange-600 hover:text-orange-700 font-medium">Tentar Novamente</button>
                </div>

                <!-- Success State -->
                <div id="qr-success" class="hidden flex flex-col items-center text-center">
                    <div
                        class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mb-4 animate-in zoom-in duration-300">
                        <i data-lucide="check" class="w-8 h-8 text-emerald-500"></i>
                    </div>
                    <h3 class="text-lg font-bold text-slate-800 mb-2">Conectado!</h3>
                    <p class="text-slate-500 text-sm">Aparelho sincronizado com sucesso.</p>
                </div>

            </div>
        </div>
    </div>

    <script>
        // Safety check for Lucide
        if (window.lucide) {
            try {
                lucide.createIcons();
            } catch (e) {
                console.warn("Lucide icons failed to load:", e);
            }
        }

        // --- AUTH SYSTEM ---
        const USERS = {
            'joaosouza@playerfranchising.com.br': { pass: 'A&A2Ts2@93', name: 'João Souza', role: 'admin' },
            'flavia@playerfranchising.com.br': { pass: '12345678', name: 'Flávia', role: 'user' }
        };

        function checkAuth() {
            try {
                const user = localStorage.getItem('scale_user');
                if (!user) {
                    document.getElementById('login-screen').classList.remove('hidden');
                    document.getElementById('app-container').classList.add('hidden');
                } else {
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('app-container').classList.remove('hidden');
                    updateUserProfile(JSON.parse(user));
                    // Ensure lucide icons re-render in app
                    if (window.lucide && typeof lucide.createIcons === 'function') {
                        lucide.createIcons();
                    }
                }
            } catch (e) {
                console.error("Auth Fail", e);
                // Fallback to login if auth check fails
                document.getElementById('login-screen').classList.remove('hidden');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            const btn = document.getElementById('login-btn');

            if (!email || !pass) {
                // Should be handled by required attribute, but fallback:
                if (errorEl) {
                    errorEl.innerText = "Preencha todos os campos.";
                    errorEl.classList.remove('hidden');
                }
                return;
            }

            // UI Loading State
            const originalText = btn.innerText;
            btn.innerText = 'Entrando...';
            btn.disabled = true;

            setTimeout(() => {
                if (USERS[email] && USERS[email].pass === pass) {
                    // Success
                    const userData = { email, name: USERS[email].name, role: USERS[email].role };
                    localStorage.setItem('scale_user', JSON.stringify(userData));

                    if (errorEl) errorEl.classList.add('hidden');

                    checkAuth();

                    // Reset Button (although view changes, good practice)
                    btn.innerText = originalText;
                    btn.disabled = false;
                } else {
                    // Error
                    if (errorEl) {
                        errorEl.innerHTML = '<i data-lucide="alert-circle" class="w-4 h-4 mr-2"></i> Credenciais inválidas';
                        errorEl.classList.remove('hidden');
                    }
                    if (window.lucide) lucide.createIcons();

                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }, 600);
        }

        function handleLogout() {
            const overlay = document.getElementById('global-loading-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }

            setTimeout(() => {
                localStorage.removeItem('scale_user');
                checkAuth();

                if (overlay) {
                    overlay.classList.add('opacity-0');
                    setTimeout(() => {
                        overlay.classList.remove('flex', 'opacity-0');
                        overlay.classList.add('hidden');
                    }, 300);
                }
            }, 600);
        }

        function updateUserProfile(user) {
            // Sidebar Footer Profile
            const sidebar = document.querySelector('aside');
            if (sidebar) {
                const nameEl = sidebar.querySelector('.absolute.bottom-4 .font-medium');
                const mailEl = sidebar.querySelector('.absolute.bottom-4 .text-xs');
                // Also update the initials circle
                const initEl = sidebar.querySelector('.absolute.bottom-4 .rounded-full.bg-slate-700 span');

                if (nameEl) nameEl.innerText = user.name;
                if (mailEl) mailEl.innerText = user.email;
                if (initEl) {
                    const initials = user.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    initEl.innerText = initials;
                }
            }
        }

        // --- Facebook SDK Init ---
        window.fbAsyncInit = function () {
            FB.init({
                appId: '24154258840827764',
                cookie: true,
                xfbml: true,
                version: 'v19.0'
            });
            FB.AppEvents.logPageView();

            // Auto-Refresh Session Logic
            FB.getLoginStatus(function (response) {
                if (response.status === 'connected') {
                    console.log("[FB] Session Active. Refreshing Token...");
                    const uid = response.authResponse.userID;
                    const accessToken = response.authResponse.accessToken;

                    // Update Local Storage with fresh token
                    localStorage.setItem('fb_access_token', accessToken);
                    localStorage.setItem('fb_connected', 'true'); // Ensure flag is true

                    // Restore UI if needed (Optional, usually handled by initRealFbData check)
                    const status = document.getElementById('status-fb');
                    if (status && status.innerText === 'Desconectado') {
                        status.innerText = 'Conectado (Restaurado)';
                        status.classList.replace('bg-slate-100', 'bg-emerald-50');
                        status.classList.replace('text-slate-500', 'text-emerald-700');
                    }
                } else {
                    console.log("[FB] Session not connected:", response.status);
                }
            });
        };

        (function (d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) { return; }
            js = d.createElement(s); js.id = id;
            js.src = "https://connect.facebook.net/en_US/sdk.js";
            fjs.parentNode.insertBefore(js, fjs);
        }(document, 'script', 'facebook-jssdk'));


        // --- DATA ENGINE ---
        // Initialized as empty; populated by initDailyData() and Supabase
        let DAILY_DATA = [];

        // --- State ---
        let selectedStartDate = null;
        let selectedEndDate = null;
        let currentMonth = 0; // Jan
        let currentYear = 2026;
        let selectedCampaign = 'all'; // 'all', 'curso_ia', 'consultoria'
        let selectedProductName = 'all'; // New State for Product Filter
        const monthNames = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

        // --- Core Update Logic ---
        function refreshDashboard() {
            // 1. Determine Range
            const defaultEnd = new Date();
            const defaultStart = new Date();
            defaultStart.setDate(defaultEnd.getDate() - 6); // Last 7 days including today

            // CRITICAL: Clone dates to avoid mutating global state
            const start = selectedStartDate ? new Date(selectedStartDate) : defaultStart;
            const end = selectedEndDate ? new Date(selectedEndDate) : defaultEnd;

            // Normalize
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999);

            // Update Label if not manual
            if (!selectedStartDate) {
                // If it was a preset, logic handled elsewhere, but for safety:
                const strStart = start.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                const strEnd = end.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                document.getElementById('dateRangeLabel').innerText = `${strStart} - ${strEnd}`;
            }

            // 2. Filter Data
            const filtered = DAILY_DATA.filter(d => d.date >= start && d.date <= end);

            // 3. Aggregate
            let totalInv = 0;
            let totalRev = 0;
            let totalParticipants = 0;
            let totalSalesCount = 0;
            let totalVip = 0;
            let totalIndiv = 0;
            let totalDouble = 0;

            const chartData = filtered.map(d => {
                // --- DECOUPLED LOGIC (Per User Request) ---

                // 1. Investment Source: Follows Campaign Filter AND Text Filter
                let invSource = d.all;
                let dayInv = 0;

                // Special Case: Text Filter Active for Campaigns
                if (textFilterValue && textFilterValue.trim().length > 0) {
                    const search = textFilterValue.toLowerCase();
                    // Iterate all keys in 'd' to find campaigns matching text
                    Object.keys(d).forEach(k => {
                        // Skip non-campaign keys
                        if (k === 'date' || k === 'all' || k === 'products') return;

                        // Check if it IS a campaign object
                        if (d[k] && typeof d[k] === 'object' && d[k].investment !== undefined) {
                            const cName = CAMPAIGN_NAMES[k] ? CAMPAIGN_NAMES[k].toLowerCase() : '';
                            // Match: If Campaign Name contains text
                            if (cName.includes(search)) {
                                dayInv += d[k].investment || 0;
                            }
                        }
                    });
                }
                // Standard Campaign Filter (if no text filter OR if text filter logic should combine? User said "OR" in prompt "Se conte uma palavra... filtra")
                // Impl: If text filter is present, it OVERRIDES the dropdown selection for simplicity, OR we respect both.
                // Given "conditional", let's assume Text Filter is powerful.
                // If Text Filter is IDLE, we use Dropdown Logic.
                else if (selectedCampaignId && selectedCampaignId !== 'all') {
                    invSource = d[selectedCampaignId] || { investment: 0 };
                    dayInv = invSource.investment || 0;
                } else {
                    // All
                    dayInv = d.all.investment || 0;
                }

                totalInv += dayInv;

                // 2. Sales Source: Follows Product Filter AND Text Filter
                let salesSource = { revenue: 0, participants: 0, salesCount: 0, vips: 0, indiv: 0, double: 0 };

                // Special Case: Text Filter Active for Products
                if (textFilterValue && textFilterValue.trim().length > 0) {
                    const search = textFilterValue.toLowerCase();
                    // Iterate products
                    if (d.products) {
                        Object.keys(d.products).forEach(pName => {
                            if (pName.toLowerCase().includes(search)) {
                                const pData = d.products[pName];
                                salesSource.revenue += pData.revenue;
                                salesSource.participants += pData.participants;
                                salesSource.salesCount += pData.salesCount;
                                salesSource.vips += pData.vips;
                                salesSource.indiv += pData.indiv;
                                salesSource.double += pData.double;
                            }
                        });
                    }
                }
                else if (selectedProductName && selectedProductName !== 'all') {
                    if (d.products && d.products[selectedProductName]) {
                        salesSource = d.products[selectedProductName];
                    }
                } else {
                    // All
                    salesSource = d.all;
                }

                totalRev += salesSource.revenue;

                const parts = salesSource.participants || 0;
                const sCount = salesSource.salesCount || 0;
                totalParticipants += parts;
                totalSalesCount += sCount;

                totalVip += salesSource.vips;
                totalIndiv += salesSource.indiv;
                totalDouble += salesSource.double;

                return {
                    date: d.date,
                    inv: dayInv,
                    rev: salesSource.revenue
                };
            });

            // 4. Calculate KPIs
            const safeSalesCount = totalSalesCount > 0 ? totalSalesCount : 1;
            const safeParticipants = totalParticipants > 0 ? totalParticipants : 1; // For CPA/CAC

            const cpa = totalInv / safeParticipants; // CAC = Inv / Participants
            const ticket = totalRev / safeSalesCount; // Ticket = Rev / Sales Count

            // 5. Update UI - Cards
            const fmt = (val) => val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            document.getElementById('val-investment').innerText = fmt(totalInv);
            document.getElementById('val-revenue').innerText = fmt(totalRev);
            document.getElementById('val-cpa').innerText = totalParticipants > 0 ? fmt(cpa) : 'R$ 0,00';
            document.getElementById('val-ticket').innerText = totalSalesCount > 0 ? fmt(ticket) : 'R$ 0,00';

            document.getElementById('val-parts').innerText = totalParticipants;
            document.getElementById('val-vips').innerText = totalVip;
            document.getElementById('val-indiv').innerText = totalIndiv;
            document.getElementById('val-double').innerText = totalDouble;

            // Update Trends (Simulated based on range length comparison or random for demo)
            // For demo robustness, let's keep them static or simple random
            // document.getElementById('trend-investment').innerText = ...

            // 6. Render Charts
            renderCharts(chartData);

            // Update Chart Dates Labels
            if (chartData.length > 0) {
                const s = chartData[0].date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                const e = chartData[chartData.length - 1].date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                document.getElementById('chart-date-start').innerText = s;
                document.getElementById('chart-date-end').innerText = e;
                document.getElementById('chart-inv-start').innerText = s;
                document.getElementById('chart-inv-end').innerText = e;
            }
        }

        function renderCharts(data) {
            const revContainer = document.getElementById('revenue-chart-container');
            // Fixed: Use stable ID instead of fragile querySelector that crashes on empty data
            const invContainer = document.getElementById('investment-chart-container');

            if (!invContainer) {
                console.warn("Investment chart container not found");
                // Try fallback or just return to avoid crash if it's really missing
            }


            // Find max for scaling
            const maxRev = Math.max(...data.map(d => d.rev)) || 1;
            const maxInv = Math.max(...data.map(d => d.inv)) || 1;

            const generateBars = (type, max) => {
                let html = '';
                data.forEach(d => {
                    const val = type === 'rev' ? d.rev : d.inv;
                    const h = Math.max(5, (val / max) * 100) + '%';
                    const dateStr = d.date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                    const valStr = val.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    const colorClass = type === 'rev' ? 'bg-red-500' : 'bg-slate-800';

                    html += `
                        <div class="w-full ${colorClass} rounded-t transition-all duration-500 group relative hover:opacity-90 cursor-pointer" style="height: ${h}">
                            <div class="hidden group-hover:block absolute bottom-full left-1/2 -translate-x-1/2 mb-2 bg-slate-900 text-white text-[10px] rounded px-2 py-1 whitespace-nowrap z-10 shadow-lg font-medium">
                                ${dateStr}<br>${valStr}
                                <div class="absolute top-full left-1/2 -translate-x-1/2 border-4 border-transparent border-t-slate-900"></div>
                            </div>
                        </div>`;
                });
                return html;
            };

            revContainer.innerHTML = generateBars('rev', maxRev);

            // Fix inv container selection safely
            // The Investment Chart container is the parent of the bars.
            // In original HTML: <div class="flex-1 flex items-end justify-between gap-2 px-2">...</div> inside the 2nd chart card
            // Let's try to query it by context
            const chartCards = document.querySelectorAll('.h-80.flex-col');
            if (chartCards.length >= 2) {
                const invCont = chartCards[1].querySelector('.flex-1.flex.items-end');
                if (invCont) invCont.innerHTML = generateBars('inv', maxInv);
            }
        }

        function filterCampaigns(val) {
            selectedCampaign = val;
            refreshDashboard();
        }

        function applyDateSelection() {
            if (selectedStartDate && selectedEndDate) {
                const startStr = selectedStartDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                const endStr = selectedEndDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                document.getElementById('dateRangeLabel').innerText = `${startStr} - ${endStr}`;

                // Consistency Check: Does this range match a preset?
                const presetKeys = ['today', 'yesterday', 'last7', 'last14', 'last30', 'month', 'lastMonth'];
                let matchedKey = null;

                // Normalize selected dates to 0 hours for comparison
                const selStart = new Date(selectedStartDate); selStart.setHours(0, 0, 0, 0);
                const selEnd = new Date(selectedEndDate); selEnd.setHours(0, 0, 0, 0);

                for (let key of presetKeys) {
                    const { start, end } = getPresetDates(key);
                    if (start.getTime() === selStart.getTime() && end.getTime() === selEnd.getTime()) {
                        matchedKey = key;
                        break;
                    }
                }

                // UI Reset
                const presets = document.querySelectorAll('input[name="datePreset"]');
                presets.forEach(p => {
                    p.checked = false;
                    p.parentElement.classList.remove('bg-blue-50', 'text-blue-700', 'font-medium');
                });
                if (matchedKey) {
                    const presetIndex = presetKeys.indexOf(matchedKey);
                    if (presetIndex >= 0 && presets[presetIndex]) {
                        presets[presetIndex].checked = true;
                        presets[presetIndex].parentElement.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
                    }
                } else {
                    const customRadio = document.getElementById('preset-custom');
                    if (customRadio) {
                        customRadio.checked = true;
                        customRadio.parentElement.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
                    }
                }
                document.getElementById('datePickerDropdown').classList.add('hidden');

                // Trigger Logic
                refreshDashboard();
            }
        }

        // --- Date Calculation Helper ---
        function getPresetDates(key) {
            const today = new Date();
            const start = new Date(today);
            const end = new Date(today);

            switch (key) {
                case 'today':
                    // start/end already today
                    break;
                case 'yesterday':
                    start.setDate(today.getDate() - 1);
                    end.setDate(today.getDate() - 1);
                    break;
                case 'last7':
                    start.setDate(today.getDate() - 6);
                    break;
                case 'last14':
                    start.setDate(today.getDate() - 13);
                    break;
                case 'last30':
                    start.setDate(today.getDate() - 29);
                    break;
                case 'month': // This month
                    start.setDate(1);
                    break;
                case 'lastMonth':
                    start.setMonth(today.getMonth() - 1);
                    start.setDate(1);
                    end.setDate(0); // Last day of previous month
                case 'lifetime':
                    start.setFullYear(2024, 0, 1); // Mock lifetime start
                    break;
            }
            // Normalize times
            start.setHours(0, 0, 0, 0);
            end.setHours(23, 59, 59, 999); // Include full end days
            return { start, end };
        }

        // --- Preset Click Handlers ---
        const presets = document.querySelectorAll('input[name="datePreset"]');
        const presetMap = ['today', 'yesterday', 'last7', 'last14', 'last30', 'month', 'lastMonth', 'lifetime'];
        const labelMap = ['Hoje', 'Ontem', 'Últimos 7 dias', 'Últimos 14 dias', 'Últimos 30 dias', 'Este mês', 'Mês passado', 'Vitalício'];

        // --- Preset Logic (Refactored for Robustness) ---
        presets.forEach((radio, index) => {
            // Remove old potential inline listeners
            const label = radio.closest('label');
            if (label) label.onclick = null;

            // Use CHANGE event on the input itself (most reliable for radios)
            radio.addEventListener('change', (e) => {
                try {
                    // UI Update (Visuals)
                    presets.forEach(p => {
                        const pLabel = p.closest('label') || p.parentElement;
                        if (pLabel) pLabel.classList.remove('bg-blue-50', 'text-blue-700', 'font-medium');
                    });
                    const activeLabel = radio.closest('label') || radio.parentElement;
                    if (activeLabel) activeLabel.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');

                    // 1. Calculate and Set Dates
                    const { start, end } = getPresetDates(presetMap[index]);
                    selectedStartDate = start;
                    selectedEndDate = end;

                    // 2. Sync Calendar & Inputs
                    currentYear = selectedStartDate.getFullYear();
                    currentMonth = selectedStartDate.getMonth();
                    renderCalendars();
                    updateDateInputs();

                    document.getElementById('dateRangeLabel').innerText = labelMap[index];

                    // 3. Close Dropdown FIRST (Per User Request)
                    const d = document.getElementById('datePickerDropdown');
                    if (d) d.classList.add('hidden');

                    // 4. Update Dashboard
                    refreshDashboard();

                } catch (err) {
                    console.error("Preset Error:", err);
                    // Ensure close even on error
                    document.getElementById('datePickerDropdown').classList.add('hidden');
                }
            });
        });

        // --- Date Selection Logic ---
        function handleDateClick(d, m, y) {
            const clickedDate = new Date(y, m, d);

            if (!selectedStartDate || (selectedStartDate && selectedEndDate)) {
                // Start new selection
                selectedStartDate = clickedDate;
                selectedEndDate = null;
            } else {
                // Complete selection
                if (clickedDate < selectedStartDate) {
                    selectedEndDate = selectedStartDate;
                    selectedStartDate = clickedDate;
                } else {
                    selectedEndDate = clickedDate;
                }
            }
            renderCalendars();
            updateDateInputs();
        }

        function updateDateInputs() {
            const wrappers = document.querySelectorAll('#datePickerDropdown .border.rounded.text-center');
            if (wrappers.length >= 2) {
                if (selectedStartDate) {
                    wrappers[0].innerText = selectedStartDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
                } else {
                    wrappers[0].innerText = '-';
                }
                if (selectedEndDate) {
                    wrappers[1].innerText = selectedEndDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
                } else {
                    wrappers[1].innerText = '-';
                }
            }
        }

        // --- Calendar Rendering ---
        function renderCalendars() {
            renderMonth(currentYear, currentMonth, 'cal-container-1', 'cal-title-1');

            let nextMonth = currentMonth + 1;
            let nextYear = currentYear;
            if (nextMonth > 11) { nextMonth = 0; nextYear++; }

            renderMonth(nextYear, nextMonth, 'cal-container-2', 'cal-title-2');
        }

        function renderMonth(year, month, containerId, titleId) {
            const container = document.getElementById(containerId);
            const title = document.getElementById(titleId);
            if (!container || !title) return;

            title.innerText = `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';
            for (let i = 0; i < firstDay; i++) { html += `<div></div>`; }

            for (let d = 1; d <= daysInMonth; d++) {
                const currentDate = new Date(year, month, d);
                // Normalize dates to midnight for comparison
                const normCurrentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                const normSelectedStartDate = selectedStartDate ? new Date(selectedStartDate.getFullYear(), selectedStartDate.getMonth(), selectedStartDate.getDate()) : null;
                const normSelectedEndDate = selectedEndDate ? new Date(selectedEndDate.getFullYear(), selectedEndDate.getMonth(), selectedEndDate.getDate()) : null;

                let classes = "p-1 cursor-pointer rounded-full transition-colors flex items-center justify-center h-8 w-8 mx-auto ";

                let isStart = normSelectedStartDate && normCurrentDate.getTime() === normSelectedStartDate.getTime();
                let isEnd = normSelectedEndDate && normCurrentDate.getTime() === normSelectedEndDate.getTime();
                let isInRange = normSelectedStartDate && normSelectedEndDate && normCurrentDate > normSelectedStartDate && normCurrentDate < normSelectedEndDate;

                if (isStart || isEnd) {
                    classes += "bg-blue-600 text-white font-medium hover:bg-blue-700";
                } else if (isInRange) {
                    classes += "bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-none";
                    // To look like a contiguous bar we might need different CSS, but rounded-none helps imply continuity locally
                } else {
                    classes += "hover:bg-slate-100 text-slate-700";
                }

                html += `<div class="${classes}" onclick="handleDateClick(${d}, ${month}, ${year})">${d}</div>`;
            }
            container.innerHTML = html;
        }

        function initCalendarHTML() {
            const calWrappers = document.querySelectorAll('#datePickerDropdown .grid-cols-7.text-sm');
            if (calWrappers.length >= 2) {
                calWrappers[0].id = 'cal-container-1';
                calWrappers[1].id = 'cal-container-2';
            }
            const calTitles = document.querySelectorAll('#datePickerDropdown .flex.justify-between.font-medium span');
            if (calTitles.length >= 2) {
                calTitles[0].parentElement.innerHTML = `<button onclick="changeMonth(-1)" class="p-1 hover:bg-slate-100 rounded"><</button><span id="cal-title-1"></span><span></span>`;
                calTitles[1].parentElement.innerHTML = `<span id="cal-title-2"></span><button onclick="changeMonth(1)" class="p-1 hover:bg-slate-100 rounded">></button>`;
            }
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendars();
        }

        function toggleDatePicker() {
            const dropdown = document.getElementById('datePickerDropdown');
            dropdown.classList.toggle('hidden');
        }

        // Initialize with a default fake selection for visuals
        // MOVED TO initApp()

        // --- Profile Menu Logic ---
        function toggleProfileMenu() {
            const menu = document.getElementById('profile-dropdown');
            menu.classList.toggle('hidden');
        }

        // Close on click outside (Generalized)
        window.onclick = function (event) {
            // Check Date Picker
            const dateContainer = document.getElementById('datePickerContainer');
            if (dateContainer && !dateContainer.contains(event.target)) {
                document.getElementById('datePickerDropdown').classList.add('hidden');
            }

            // Check Sales Date Picker
            const salesDateContainer = document.getElementById('salesDatePickerContainer');
            if (salesDateContainer && !salesDateContainer.contains(event.target)) {
                const salesDropdown = document.getElementById('salesDatePickerDropdown');
                if (salesDropdown) salesDropdown.classList.add('hidden');
            }

            // Check Profile Menu
            const profileFooter = document.getElementById('profile-footer');
            if (profileFooter && !profileFooter.contains(event.target)) {
                document.getElementById('profile-dropdown').classList.add('hidden');
            }
        }

        // Fix: Stop propagation on container to prevent "click outside" logic 
        // from firing when elements (like calendar days) are removed from DOM during re-render
        const dpc = document.getElementById('datePickerContainer');
        if (dpc) dpc.addEventListener('click', function (event) { event.stopPropagation(); });

        const sdpc = document.getElementById('salesDatePickerContainer');
        if (sdpc) sdpc.addEventListener('click', function (event) { event.stopPropagation(); });

        // --- Navigation Logic ---
        // --- Navigation Logic ---
        function navigateTo(viewId) {
            console.log("Navigating to:", viewId);
            const overlay = document.getElementById('global-loading-overlay');

            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');

                // Simulate delay for smooth transition
                setTimeout(() => {
                    executeNavigation(viewId);

                    // Fade out
                    overlay.classList.add('opacity-0');
                    setTimeout(() => {
                        overlay.classList.remove('flex', 'opacity-0');
                        overlay.classList.add('hidden');
                    }, 300);
                }, 400); // 400ms delay
            } else {
                executeNavigation(viewId);
            }
        }

        function executeNavigation(viewId) {
            try {
                // Persist state
                localStorage.setItem('last_active_view', viewId);

                // Add all views to manage (INCLUDING WHATSAPP)
                const views = ['dashboard', 'settings', 'agents', 'vendas', 'whatsapp'];

                // Hide all views
                views.forEach(v => {
                    const el = document.getElementById('view-' + v);
                    if (el) {
                        el.classList.add('hidden');
                        el.classList.remove('fade-in');
                    }
                });

                // Show target
                const target = document.getElementById('view-' + viewId);
                if (target) {
                    target.classList.remove('hidden');
                    console.log("View shown:", viewId);

                    // Auto-center Organogram if opening Agents view
                    if (viewId === 'agents') {
                        setTimeout(() => {
                            if (typeof fitOrganogram === 'function') fitOrganogram();
                        }, 50);
                    }
                } else {
                    console.error("Target view not found:", viewId);
                }

                // Close menus if open
                const profile = document.getElementById('profile-dropdown');
                if (profile) profile.classList.add('hidden');

                // --- Toggle Sidebar Active State ---
                const navDashboard = document.getElementById('nav-dashboard');
                const navSettings = document.getElementById('nav-settings');
                // Assume navAgents exists or is part of a submenu
                // If there's a specific nav item for agents, toggle it here too.
                // For now, handling Dashboard/Settings as before.

                // Classes for styling
                const activeClasses = ['bg-red-600/10', 'text-red-500'];
                const inactiveClasses = ['text-slate-400', 'hover:bg-slate-800', 'hover:text-white'];

                // Helper to set state
                const setActive = (el, isActive) => {
                    if (!el) return;
                    if (isActive) {
                        el.classList.add(...activeClasses);
                        el.classList.remove(...inactiveClasses);
                    } else {
                        el.classList.remove(...activeClasses);
                        el.classList.add(...inactiveClasses);
                    }
                };

                if (viewId === 'settings') {
                    setActive(navDashboard, false);
                    setActive(navSettings, true);
                } else if (viewId === 'dashboard') {
                    setActive(navDashboard, true);
                    setActive(navSettings, false);
                } else {
                    // For 'agents', maybe we want to deactivate both or set a sub-item?
                    // Keeping dashboard active is potentially confusing if not sub-item.
                    // Let's deactivate both for now if 'agents' to show specialized state
                    setActive(navDashboard, false);
                    setActive(navSettings, false);
                }
            } catch (e) {
                console.error("Navigation error:", e);
                alert("Erro ao navegar: " + e.message);
            }
        }

        // --- Integration Logic ---
        function connectIntegration(type) {
            if (type === 'fb') {
                const btn = document.getElementById('btn-connect-fb');
                const status = document.getElementById('status-fb');

                // Immediate feedback
                const originalText = btn.innerText;

                // TOGGLE LOGIC: If already connected, disconnect.
                if (originalText === 'Desconectar') {
                    // Logic to disconnect
                    btn.innerText = 'Conectar Conta';

                    // Revert Button Styles
                    btn.classList.replace('bg-slate-200', 'bg-blue-600');
                    btn.classList.replace('text-slate-700', 'text-white');
                    btn.classList.replace('hover:bg-slate-300', 'hover:bg-blue-700');

                    // Revert Status Badge
                    status.innerText = 'Desconectado';
                    status.classList.replace('bg-blue-50', 'bg-slate-100');
                    status.classList.replace('text-blue-600', 'text-slate-500');

                    // Optional: Call FB.logout if using real SDK, but for demo/simulation just UI reset is enough
                    /* 
                    if (typeof FB !== 'undefined') { FB.logout(); } 
                    */
                    return;
                }

                btn.innerText = 'Processando...';
                btn.disabled = true;

                // Dependencies
                // const isSdkLoaded = typeof FB !== 'undefined'; // Moved inside setTimeout
                // let responseReceived = false; // No longer needed with simplified logic

                // 1. Safety Timeout: If FB popup is blocked/closed without callback, we ask user manually
                // const safetyTimer = setTimeout(() => { // No longer needed
                //     if (!responseReceived) {
                //         const isLocalFile = window.location.protocol === 'file:';
                //         if (isLocalFile) {
                //             if (confirm("O Facebook parece não ter respondido (comum em arquivos locais).\n\nDeseja ativar a SIMULAÇÃO?")) {
                //                 fallbackSimulation(btn, status);
                //             } else {
                //                 resetBtn(btn, originalText);
                //             }
                //         } else {
                //             resetBtn(btn, originalText);
                //         }
                //     }
                // }, 5000); // 5 seconds wait

                setTimeout(() => {
                    // 1. Pre-check: File Protocol (Always fails with FB)
                    if (window.location.protocol === 'file:') {
                        if (confirm("⚠️ Modo Local Detectado\n\nO Login do Facebook exige um servidor seguro (HTTPS) e não funciona direto do arquivo (file://).\n\nPara testar o painel, podemos SIMULAR uma conexão bem-sucedida.\n\nDeseja conectar em modo SIMULAÇÃO?")) {
                            fallbackSimulation(btn, status);
                        } else {
                            resetBtn(btn, originalText);
                        }
                        return; // Stop here, don't call FB.login
                    }

                    // 2. Real FB Login (for Server/HTTPS)
                    const isSdkLoaded = typeof FB !== 'undefined';
                    if (isSdkLoaded) {
                        try {
                            FB.login(function (response) {
                                if (response.status === 'connected') {
                                    handleFbSuccess(btn, status, 'Meta SDK');
                                    // Init Real Data Fetch
                                    if (response.authResponse) {
                                        initRealFbData(response.authResponse.accessToken);
                                    }
                                } else {
                                    alert('Login cancelado ou não autorizado.');
                                    resetBtn(btn, originalText);
                                }
                            }, {
                                scope: 'public_profile,email,ads_read,read_insights,business_management,pages_show_list,ads_management,leads_retrieval,pages_read_engagement,pages_manage_metadata,pages_manage_ads',
                                auth_type: 'reauthenticate'
                            });
                        } catch (e) {
                            console.error("FB Login Error:", e);
                            alert('Erro ao iniciar o SDK. Verifique o console.');
                            resetBtn(btn, originalText);
                        }
                    } else {
                        // SDK not loaded
                        if (confirm('SDK do Facebook não carregou (comum com AdBlockers).\n\nDeseja usar o modo SIMULAÇÃO?')) {
                            fallbackSimulation(btn, status);
                        } else {
                            resetBtn(btn, originalText);
                        }
                    }
                }, 500);
            }

            if (type === 'go') {
                const form = document.getElementById('go-connect-form');
                const msg = document.getElementById('go-connected-msg');
                const status = document.getElementById('status-go');
                const btn = form.querySelector('button[onclick*="connectIntegration"]');

                // Simulate Webhook Verification
                const originalText = btn.innerText;
                btn.innerText = 'Aguardando evento...';
                btn.disabled = true;
                btn.classList.add('animate-pulse');

                setTimeout(() => {
                    // Success Simulation
                    localStorage.setItem('go_connected', 'true'); // Persist

                    form.classList.add('hidden');
                    msg.classList.remove('hidden');

                    // Update Status Badge
                    status.classList.remove('hidden');
                    status.innerText = 'Conectado';
                    status.classList.replace('hidden', 'flex');

                    msg.innerHTML = `
                        <div class="flex items-center justify-between w-full">
                            <span class="flex items-center font-medium text-emerald-700">
                                <i data-lucide="check-circle" class="w-4 h-4 mr-2 text-emerald-500"></i> 
                                Webhook recebido com sucesso!
                            </span>
                            <button onclick="disconnectGo()" class="text-xs text-red-500 hover:text-red-700 font-medium ml-4 underline decoration-red-200">Desconfigurar</button>
                        </div>
                        <p class="text-xs text-emerald-600 mt-1 pl-6">Recebemos um evento de teste da GoExplosion.</p>
                    `;
                    lucide.createIcons();
                }, 2000); // 2s delay
            }
        }

        function copyWebhookUrl() {
            const input = document.getElementById('webhook-url');
            input.select();
            input.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(input.value).then(() => {
                // Visual feedback
                input.classList.add('border-blue-500', 'text-blue-600');
                setTimeout(() => {
                    input.classList.remove('border-blue-500', 'text-blue-600');
                }, 500);
            }).catch(err => {
                console.error('Erro ao copiar', err);
                input.select();
                document.execCommand('copy');
            });
        }

        function disconnectGo() {
            if (!confirm('Deseja remover a integração? O sistema parará de receber vendas da GoExplosion.')) return;

            localStorage.removeItem('go_connected');

            const form = document.getElementById('go-connect-form');
            const msg = document.getElementById('go-connected-msg');
            const status = document.getElementById('status-go');
            const btn = form.querySelector('button[onclick*="connectIntegration"]');

            // Reset UI
            btn.innerText = 'Verificar Conexão';
            btn.disabled = false;
            btn.classList.remove('animate-pulse');

            form.classList.remove('hidden');
            msg.classList.add('hidden');
            status.classList.add('hidden');
        }

        function handleFbSuccess(btn, status, source) {
            btn.innerText = 'Desconectar';
            btn.classList.replace('bg-blue-600', 'bg-slate-200');
            btn.classList.replace('text-white', 'text-slate-700');
            btn.classList.replace('hover:bg-blue-700', 'hover:bg-slate-300');
            btn.disabled = false;
            btn.onclick = disconnectFb; // Change action to disconnect

            status.innerText = `Conectado (${source})`;
            status.classList.replace('bg-slate-100', 'bg-blue-50');
            status.classList.replace('text-slate-500', 'text-blue-600');
            status.classList.remove('hidden');
        }

        function disconnectFb() {
            if (!confirm("Deseja desconectar a conta do Facebook?")) return;

            // Clear Storage
            localStorage.removeItem('fb_access_token');
            localStorage.removeItem('fb_selected_account_id');
            localStorage.removeItem('fb_selected_account_name');

            // Reset UI
            const btn = document.getElementById('btn-connect-fb');
            const status = document.getElementById('status-fb');

            if (btn) {
                btn.innerText = 'Conectar Conta';
                btn.classList.replace('bg-slate-200', 'bg-blue-600');
                btn.classList.replace('text-slate-700', 'text-white');
                btn.classList.replace('hover:bg-blue-700', 'hover:bg-slate-300');
                btn.onclick = () => connectIntegration('fb'); // Restore original action
            }

            if (status) {
                status.classList.add('hidden');
                status.innerText = '';
            }

            // Clear Data
            DAILY_DATA = []; // Or restore mock? For now, clear.
            alert("Desconectado com sucesso.");
            window.location.reload(); // Reload to reset state clean
        }

        function resetBtn(btn, text) {
            btn.innerText = text;
            btn.disabled = false;
        }

        function fallbackSimulation(btn, status) {
            setTimeout(() => {
                handleFbSuccess(btn, status, 'Simulação');
            }, 1000);
        }

        // --- Sidebar Logic ---
        let isSidebarCollapsed = false;
        function toggleSidebar() {
            isSidebarCollapsed = !isSidebarCollapsed;
            const sidebar = document.getElementById('sidebar');
            const header = document.getElementById('sidebar-header');
            const logo = document.getElementById('sidebar-logo');
            const texts = document.querySelectorAll('.sidebar-text');
            const toggleIcon = document.getElementById('sidebar-toggle-icon');
            const dashboardSubmenu = document.getElementById('dashboard-submenu');
            const navDashboardParent = document.getElementById('nav-dashboard-parent');
            const navSettings = document.getElementById('nav-settings');
            const navVendas = document.getElementById('nav-vendas');
            const navTimeParent = document.getElementById('nav-time-parent');
            const timeSubmenu = document.getElementById('time-submenu');

            if (isSidebarCollapsed) {
                // Collapse
                sidebar.classList.remove('w-64');
                sidebar.classList.add('w-20');

                // Force close submenu IMMEDIATELY and hide to prevent ghosts
                if (dashboardSubmenu) {
                    toggleDashboardMenu(true); // Retract
                    dashboardSubmenu.classList.add('hidden'); // Force hide
                }
                if (timeSubmenu) {
                    toggleTimeMenu(true);
                    timeSubmenu.classList.add('hidden');
                }

                // Adjust Header
                header.classList.remove('flex-row', 'justify-between', 'px-4');
                header.classList.add('flex-col', 'justify-center', 'items-center', 'gap-1', 'py-2', 'h-24');

                logo.innerHTML = 'S<span class="text-red-500">M</span>';
                logo.classList.remove('text-xl');
                logo.classList.add('text-lg');

                // Text & Chevrons
                texts.forEach(t => {
                    t.classList.add('opacity-0', 'w-0', 'hidden');
                    t.parentElement.classList.remove('ml-3'); // Remove margin to allow center
                });

                // Fix Dashboard Parent Button Alignment
                if (navDashboardParent) {
                    navDashboardParent.classList.remove('justify-between', 'px-3');
                    navDashboardParent.classList.add('justify-center', 'px-0');
                }

                // Fix Settings Button Alignment
                if (navSettings) {
                    navSettings.classList.remove('px-3'); // Default is flex start
                    navSettings.classList.add('justify-center', 'px-0');
                }
                // Fix Vendas Button Alignment
                if (navVendas) {
                    navVendas.classList.remove('px-3');
                    navVendas.classList.add('justify-center', 'px-0');
                }
                if (navTimeParent) {
                    navTimeParent.classList.remove('justify-between', 'px-3');
                    navTimeParent.classList.add('justify-center', 'px-0');
                }

                // Hide chevrons
                const chevrons = sidebar.querySelectorAll('.lucide-chevron-down');
                chevrons.forEach(c => c.classList.add('hidden'));

                toggleIcon.style.transform = 'rotate(180deg)';

            } else {
                // Expand
                sidebar.classList.remove('w-20');
                sidebar.classList.add('w-64');

                // Header
                header.classList.add('flex-row', 'justify-between', 'px-4', 'items-center');
                header.classList.remove('flex-col', 'justify-center', 'gap-1', 'py-2', 'h-24');

                logo.innerHTML = 'Scale<span class="text-red-500">Marketing</span>';
                logo.classList.add('text-xl');
                logo.classList.remove('text-lg');

                texts.forEach(t => {
                    t.classList.remove('opacity-0', 'w-0', 'hidden');
                    t.parentElement.classList.add('ml-3'); // Restore margin
                });

                // Fix Dashboard Parent Button Alignment
                if (navDashboardParent) {
                    navDashboardParent.classList.add('justify-between', 'px-3');
                    navDashboardParent.classList.remove('justify-center', 'px-0');
                }

                // Fix Settings Button Alignment
                if (navSettings) {
                    navSettings.classList.add('px-3');
                    navSettings.classList.remove('justify-center', 'px-0');
                }
                // Fix Vendas Button Alignment
                if (navVendas) {
                    navVendas.classList.add('px-3');
                    navVendas.classList.remove('justify-center', 'px-0');
                }
                if (navTimeParent) {
                    navTimeParent.classList.add('justify-between', 'px-3');
                    navTimeParent.classList.remove('justify-center', 'px-0');
                }

                // Show chevrons
                const chevrons = sidebar.querySelectorAll('.lucide-chevron-down');
                chevrons.forEach(c => c.classList.remove('hidden'));

                toggleIcon.style.transform = 'rotate(0deg)';

                // Note: We don't auto-open submenu, keeps clean
            }
        }

        // --- Dashboard Submenu Logic ---
        function toggleSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            const backdrop = document.getElementById('sidebar-backdrop');

            // Toggle translate class
            if (sidebar.classList.contains('-translate-x-full')) {
                // Open
                sidebar.classList.remove('-translate-x-full');
                backdrop.classList.remove('hidden');
                setTimeout(() => backdrop.classList.remove('opacity-0'), 10); // Fade in
            } else {
                // Close
                sidebar.classList.add('-translate-x-full');
                backdrop.classList.add('opacity-0');
                setTimeout(() => backdrop.classList.add('hidden'), 300); // Wait for fade out
            }
        }

        // --- Toggle Growth Menu ---
        function toggleGrowthMenu(forceClose = false) {
            if (!forceClose && isSidebarCollapsed) {
                toggleSidebar();
            }

            const submenu = document.getElementById('growth-submenu');
            const chevron = document.getElementById('growth-chevron');

            // Quick safety check
            if (!submenu || !chevron) return;

            // Initial Setup for animation if still using 'hidden' (Legacy fix)
            if (submenu.classList.contains('hidden')) {
                submenu.classList.remove('hidden');
                submenu.classList.add('max-h-0', 'opacity-0', 'overflow-hidden', 'transition-all', 'duration-300', 'ease-in-out');
                // Force reflow
                void submenu.offsetWidth;
            }

            const isClosed = submenu.classList.contains('max-h-0') || forceClose;

            if (forceClose) {
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100'); // Arbitrary large height
                chevron.style.transform = 'rotate(0deg)';
                return;
            }

            if (isClosed) {
                // Open
                submenu.classList.remove('max-h-0', 'opacity-0');
                submenu.classList.add('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                // Close
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // --- Toggle Automations Menu ---
        function toggleAutomationsMenu(forceClose = false) {
            if (!forceClose && isSidebarCollapsed) {
                toggleSidebar();
            }

            const submenu = document.getElementById('automations-submenu');
            const chevron = document.getElementById('automations-chevron');

            // Quick safety check
            if (!submenu || !chevron) return;

            // Initial Setup for animation if still using 'hidden'
            if (submenu.classList.contains('hidden')) {
                submenu.classList.remove('hidden');
                submenu.classList.add('max-h-0', 'opacity-0', 'overflow-hidden', 'transition-all', 'duration-300', 'ease-in-out');
                // Force reflow
                void submenu.offsetWidth;
            }

            const isClosed = submenu.classList.contains('max-h-0') || forceClose;

            if (forceClose) {
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100'); // Arbitrary large height
                chevron.style.transform = 'rotate(0deg)';
                return;
            }

            if (isClosed) {
                // Open
                submenu.classList.remove('max-h-0', 'opacity-0');
                submenu.classList.add('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                // Close
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function toggleDashboardMenu(forceClose = false) {
            if (!forceClose && isSidebarCollapsed) {
                toggleSidebar();
            }

            const submenu = document.getElementById('dashboard-submenu');
            const chevron = document.getElementById('dashboard-chevron');

            // Initial Setup for animation if still using 'hidden' (Legacy fix)
            if (submenu.classList.contains('hidden')) {
                submenu.classList.remove('hidden');
                submenu.classList.add('max-h-0', 'opacity-0', 'overflow-hidden', 'transition-all', 'duration-300', 'ease-in-out');
                // Force reflow
                void submenu.offsetWidth;
            }

            const isClosed = submenu.classList.contains('max-h-0') || forceClose;

            if (forceClose) {
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100'); // Arbitrary large height
                chevron.style.transform = 'rotate(0deg)';
                return;
            }

            if (isClosed) {
                // Open
                submenu.classList.remove('max-h-0', 'opacity-0');
                submenu.classList.add('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                // Close
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        function toggleTimeMenu(forceClose = false) {
            if (!forceClose && isSidebarCollapsed) {
                toggleSidebar();
            }

            const submenu = document.getElementById('time-submenu');
            const chevron = document.getElementById('time-chevron');

            if (!submenu || !chevron) return;

            // Initial Setup for animation if still using 'hidden' (Legacy fix)
            if (submenu.classList.contains('hidden')) {
                submenu.classList.remove('hidden');
                submenu.classList.add('max-h-0', 'opacity-0', 'overflow-hidden', 'transition-all', 'duration-300', 'ease-in-out');
                // Force reflow
                void submenu.offsetWidth;
            }

            const isClosed = submenu.classList.contains('max-h-0') || forceClose;

            if (forceClose) {
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100'); // Arbitrary large height
                chevron.style.transform = 'rotate(0deg)';
                return;
            }

            if (isClosed) {
                // Open
                submenu.classList.remove('max-h-0', 'opacity-0');
                submenu.classList.add('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(180deg)';
            } else {
                // Close
                submenu.classList.add('max-h-0', 'opacity-0');
                submenu.classList.remove('max-h-96', 'opacity-100');
                chevron.style.transform = 'rotate(0deg)';
            }
        }

        // --- Agent Logic ---
        const AGENT_MODELS = {
            'openai': [
                { id: 'gpt-4-turbo', name: 'GPT-4 Turbo' },
                { id: 'gpt-4o', name: 'GPT-4o' },
                { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo' }
            ],
            'anthropic': [
                { id: 'claude-3-5-sonnet-20240620', name: 'Claude 3.5 Sonnet' },
                { id: 'claude-3-opus-20240229', name: 'Claude 3 Opus' },
                { id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku' }
            ],
            'google': [
                { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro' },
                { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash' }
            ]
        };

        // --- INTERACTIVE ORGANOGRAM LOGIC ---
        let organogramState = {
            scale: 1,
            pan: { x: 0, y: 0 },
            isDraggingCanvas: false,
            isDraggingCard: false,
            isDraggingConnection: false, // New: Track connection drag
            connectionStartId: null,     // New: Store source card ID
            dragStart: { x: 0, y: 0 },
            activeCardId: null,
            connections: [
                { id: 'conn-1', from: 'card-ceo', to: 'card-traffic' },
                { id: 'conn-2', from: 'card-ceo', to: 'card-copy' },
                { id: 'conn-3', from: 'card-ceo', to: 'card-content' },
                { id: 'conn-4', from: 'card-ceo', to: 'card-sales' }
            ],
            editingAgentId: null // New: Track which agent is being edited
        };

        // --- PERSISTENCE LOGIC ---
        function saveState() {
            // Save Agents (Scrape from DOM for now, or maintain a parallel array. Scraping is robust for this hybrid setup)
            const agents = [];
            document.querySelectorAll('[id^="card-"]').forEach(card => {
                agents.push({
                    id: card.id,
                    left: card.style.left,
                    top: card.style.top,
                    name: card.querySelector('[data-field="name"]')?.textContent || 'CEO', // CEO might not have data-field name if not fully updated, but we added it
                    desc: card.querySelector('[data-field="desc"]')?.textContent || '',
                    provider: card.querySelector('[data-field="provider"]')?.textContent || '',
                    model: card.querySelector('[data-field="model"]')?.textContent || ''
                });
            });

            const state = {
                agents: agents,
                connections: organogramState.connections
            };
            localStorage.setItem('scale_organogram_data', JSON.stringify(state));
        }

        function loadState() {
            const data = localStorage.getItem('scale_organogram_data');
            if (!data) return; // Use defaults (HTML structure)

            const state = JSON.parse(data);

            // Restore Connections
            if (state.connections) {
                organogramState.connections = state.connections;
            }

            // Restore Agents
            if (state.agents && state.agents.length > 0) {
                const content = document.getElementById('organogram-content');
                // We need to sync: 
                // 1. Update existing cards
                // 2. Create missing cards
                // 3. Delete extra cards (optional, but good for consistency)

                // Set of IDs in storage
                const storedIds = new Set(state.agents.map(a => a.id));

                // 1. Remove cards not in storage
                document.querySelectorAll('[id^="card-"]').forEach(card => {
                    if (!storedIds.has(card.id)) {
                        card.remove();
                    }
                });

                // 2. Update or Create
                state.agents.forEach(agent => {
                    let card = document.getElementById(agent.id);
                    if (card) {
                        // Update Position
                        card.style.left = agent.left;
                        card.style.top = agent.top;
                        // Update Content
                        if (agent.id !== 'card-ceo') { // Allow CEO updates too if desired, user said "including CEO"
                            const nameEl = card.querySelector('[data-field="name"]');
                            if (nameEl) nameEl.textContent = agent.name;
                            const descEl = card.querySelector('[data-field="desc"]');
                            if (descEl) descEl.textContent = agent.desc;
                            const provEl = card.querySelector('[data-field="provider"]');
                            if (provEl) provEl.textContent = agent.provider;
                            const modEl = card.querySelector('[data-field="model"]');
                            if (modEl) modEl.textContent = agent.model;
                        } else {
                            // Similar update for CEO if fields exist
                            const nameEl = card.querySelector('[data-field="name"]');
                            if (nameEl) nameEl.textContent = agent.name;
                            const descEl = card.querySelector('[data-field="desc"]');
                            if (descEl) descEl.textContent = agent.desc;
                            const provEl = card.querySelector('[data-field="provider"]');
                            if (provEl) provEl.textContent = agent.provider;
                            const modEl = card.querySelector('[data-field="model"]');
                            if (modEl) modEl.textContent = agent.model;
                        }
                    } else {
                        // Create New Card
                        // We can reuse appendAgentToGrid but need to force ID and position
                        // Or just create manually to ensure exact ID restore
                        appendAgentToGrid({
                            name: agent.name,
                            desc: agent.desc,
                            provider: agent.provider,
                            model: agent.model,
                            slug: agent.id.replace('card-', '').split('-')[0] // approx slug
                        }, agent.id, agent.left, agent.top);
                    }
                });
            }

            // Draw lines after restore
            setTimeout(drawConnections, 50);
        }

        // Initialize listeners
        setTimeout(() => {
            loadState(); // Load data on init
            const container = document.getElementById('organogram-container');
            const content = document.getElementById('organogram-content');

            if (container && content) {
                // Mouse Listeners
                container.addEventListener('mousedown', handleCanvasMouseDown);
                window.addEventListener('mousemove', handleGlobalMouseMove);
                window.addEventListener('mouseup', handleGlobalMouseUp);

                // Touch Listeners (Mobile Support)
                container.addEventListener('touchstart', (e) => {
                    if (e.touches.length > 1) return; // Allow pinch zooom maybe?
                    const t = e.touches[0];
                    // Delegate to canvas MouseDown
                    handleCanvasMouseDown({
                        clientX: t.clientX,
                        clientY: t.clientY,
                        target: e.target,
                        preventDefault: () => e.preventDefault(),
                        closest: (s) => e.target.closest(s)
                    });
                }, { passive: false });

                window.addEventListener('touchmove', (e) => {
                    const t = e.touches[0];
                    // Prevent scroll if dragging
                    if (organogramState.isDraggingCanvas || organogramState.isDraggingCard || organogramState.isDraggingConnection) {
                        e.preventDefault();
                    }
                    handleGlobalMouseMove({ clientX: t.clientX, clientY: t.clientY });
                }, { passive: false });

                window.addEventListener('touchend', (e) => {
                    const t = e.changedTouches[0];
                    const realTarget = document.elementFromPoint(t.clientX, t.clientY);
                    handleGlobalMouseUp({
                        clientX: t.clientX,
                        clientY: t.clientY,
                        target: realTarget || e.target
                    });
                });

                // Card Listeners
                document.querySelectorAll('#organogram-content > div[id^="card-"]').forEach(card => {
                    card.addEventListener('mousedown', handleCardMouseDown);
                    card.addEventListener('touchstart', (e) => {
                        const t = e.touches[0];
                        handleCardMouseDown({
                            clientX: t.clientX,
                            clientY: t.clientY,
                            currentTarget: card,
                            stopPropagation: () => e.stopPropagation(),
                            target: e.target,
                            closest: (s) => e.target.closest(s),
                            preventDefault: () => { }
                        });
                    }, { passive: false });

                    const dotOut = card.querySelector('.connection-dot-out');
                    if (dotOut) {
                        dotOut.addEventListener('mousedown', (e) => handleDotMouseDown(e, card.id));
                        dotOut.addEventListener('touchstart', (e) => {
                            e.stopPropagation(); e.preventDefault();
                            handleDotMouseDown({
                                stopPropagation: () => { },
                                preventDefault: () => { }
                            }, card.id);
                        }, { passive: false });
                    }
                });

                // Initial Draw
                drawConnections();
            }
        }, 1000);

        function handleCanvasMouseDown(e) {
            if (e.target.closest('[id^="card-"]')) return; // Ignore if clicking a card
            if (e.target.closest('button')) return; // Ignore zoom buttons

            organogramState.isDraggingCanvas = true;
            organogramState.dragStart = { x: e.clientX - organogramState.pan.x, y: e.clientY - organogramState.pan.y };
            document.getElementById('organogram-container').classList.add('cursor-grabbing');
        }

        function handleCardMouseDown(e) {
            e.stopPropagation(); // Prevent canvas drag
            // Ignore buttons inside card or dots (handled separately)
            if (e.target.closest('button') || e.target.classList.contains('connection-dot-out')) return;

            organogramState.isDraggingCard = true; // Re-enabled for Absolute Layout
            organogramState.activeCardId = e.currentTarget.id;

            const card = e.currentTarget;
            organogramState.dragStart = {
                mouseX: e.clientX,
                mouseY: e.clientY,
                cardLeft: parseFloat(card.style.left) || 0,
                cardTop: parseFloat(card.style.top) || 0
            };

            card.classList.add('z-50'); // Bring to front when dragging
        }

        // Helper to get precise dot center in SVG coordinates
        function getDotCenter(cardId, type) {
            const card = document.getElementById(cardId);
            if (!card) return null;

            const selector = type === 'out' ? '.connection-dot-out .conn-dot' : '.connection-dot-in .conn-dot';
            const dot = card.querySelector(selector);
            if (!dot) return null;

            const dotRect = dot.getBoundingClientRect();
            const contentRect = document.getElementById('organogram-content').getBoundingClientRect();
            const scale = organogramState.scale;

            // Calculate relative to content origin (0,0)
            const relX = (dotRect.left + dotRect.width / 2 - contentRect.left) / scale;
            const relY = (dotRect.top + dotRect.height / 2 - contentRect.top) / scale;

            // No offset needed for w-full h-full SVG
            return { x: relX, y: relY };
        }

        function fitOrganogram() {
            // Reset pan/zoom to center the Flexbox layout
            if (window.panzoom) {
                window.panzoom.zoomAbs(0, 0, 1);
                window.panzoom.moveTo(0, 0);
            }
            // Redraw connections to match new positions
            setTimeout(() => {
                drawConnections();
            }, 50);
        }

        function appendAgentToGrid(data, forcedId = null, forcedLeft = null, forcedTop = null) {
            const content = document.getElementById('organogram-content');
            if (!content) {
                console.warn("Organogram content container not found");
                return;
            }

            // Create unique ID
            let cardId = forcedId;
            if (!cardId) {
                const validSlug = data.slug.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                cardId = `card-${validSlug}-${Date.now()}`;
            }

            const card = document.createElement('div');
            // Absolute positioning for "Fixed but Movable" layout
            card.className = 'absolute z-10 group w-72 animate-in fade-in zoom-in duration-500';
            card.id = cardId;

            // Initial Position
            if (forcedLeft && forcedTop) {
                card.style.left = forcedLeft;
                card.style.top = forcedTop;
            } else {
                card.style.left = '0px';
                card.style.top = '350px';
            }

            card.innerHTML = `
        <!-- Input Connection Area (Top) -->
        <div class="conn-hit-area top-point connection-dot-in">
             <div class="conn-dot"></div>
        </div>
        
        <!-- Output Connection Area (Bottom) -->
        <div class="conn-hit-area bottom-point connection-dot-out"
             onmousedown="handleDotMouseDown(event, '${cardId}')">
             <div class="conn-dot"></div>
        </div>

        <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                    <i data-lucide="bot" class="w-4 h-4 text-orange-600"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="flex items-center justify-between mb-1 gap-2">
                        <h3 class="font-bold text-slate-800 text-sm truncate" data-field="name">${data.name}</h3>
                        <span class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">Ativo</span>
                    </div>
                    <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3" data-field="desc">${data.desc}</p>
                    <div class="flex gap-1 mb-1 flex-wrap">
                        <span class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded" data-field="provider">${data.provider}</span>
                        <span class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded" data-field="model">${data.model}</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                <button class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity" onclick="previewAgent('${cardId}')"><i data-lucide="eye" class="w-3 h-3"></i></button>
                <button class="hover:text-orange-500 opacity-0 group-hover:opacity-100 transition-opacity" onclick="editAgent('${cardId}')"><i data-lucide="settings" class="w-3 h-3"></i></button>
                <button class="hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity" onclick="deleteAgent('${cardId}')"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
            </div>
        </div>`;

            // Attach Drag Event (Card Body) mostly handled by global logic, but we need to ensure card is targetable
            card.addEventListener('mousedown', handleCardMouseDown);

            content.appendChild(card);

            // Attach Touch Events dynamically for new card
            card.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                handleCardMouseDown({
                    clientX: t.clientX,
                    clientY: t.clientY,
                    currentTarget: card,
                    stopPropagation: () => e.stopPropagation(),
                    target: e.target,
                    closest: (s) => e.target.closest(s),
                    preventDefault: () => { }
                });
            }, { passive: false });

            const dotOut = card.querySelector('.connection-dot-out');
            if (dotOut) {
                dotOut.addEventListener('touchstart', (e) => {
                    e.stopPropagation(); e.preventDefault();
                    handleDotMouseDown({
                        stopPropagation: () => { },
                        preventDefault: () => { }
                    }, cardId);
                }, { passive: false });
            }

            if (window.lucide) lucide.createIcons();

            // Refresh connections
            setTimeout(drawConnections, 50);
        }
        function handleDotMouseDown(e, cardId) {
            e.stopPropagation();
            e.preventDefault();

            const startPos = getDotCenter(cardId, 'out');
            if (!startPos) return;

            organogramState.isDraggingConnection = true;
            organogramState.connectionStartId = cardId;
            organogramState.dragStartPoint = startPos; // Cache start point

            // Create Temp Line in High Z-Index Layer
            const svg = document.getElementById('temp-connections-layer');
            svg.innerHTML = '';

            const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
            path.id = "temp-connection-line";
            path.setAttribute("stroke", "#fb923c");
            path.setAttribute("stroke-width", "3");
            path.setAttribute("stroke-dasharray", "5,5");
            path.setAttribute("fill", "none");
            path.setAttribute("pointer-events", "none");

            // Initial Draw (Zero length)
            path.setAttribute("d", `M ${startPos.x} ${startPos.y} L ${startPos.x} ${startPos.y}`);

            svg.appendChild(path);
        }

        function handleGlobalMouseMove(e) {
            if (organogramState.isDraggingConnection) {
                const path = document.getElementById('temp-connection-line');
                if (!path || !organogramState.dragStartPoint) return;

                const contentRect = document.getElementById('organogram-content').getBoundingClientRect();
                const scale = organogramState.scale;

                const startX = organogramState.dragStartPoint.x;
                const startY = organogramState.dragStartPoint.y;

                // End Point (Mouse) + SVG Offset
                const endX = ((e.clientX - contentRect.left) / scale);
                const endY = ((e.clientY - contentRect.top) / scale);

                // Bezier Curve
                const cp1x = startX;
                const cp1y = startY + 50;
                const cp2x = endX;
                const cp2y = endY - 50;

                path.setAttribute("d", `M ${startX} ${startY} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${endX} ${endY}`);

            } else if (organogramState.isDraggingCanvas) {
                organogramState.pan.x = e.clientX - organogramState.dragStart.x;
                organogramState.pan.y = e.clientY - organogramState.dragStart.y;
                updateOrganogramTransform();
            } else if (organogramState.isDraggingCard && organogramState.activeCardId) {
                const card = document.getElementById(organogramState.activeCardId);
                const scale = organogramState.scale;
                const newLeft = organogramState.dragStart.cardLeft + (e.clientX - organogramState.dragStart.mouseX) / scale;
                const newTop = organogramState.dragStart.cardTop + (e.clientY - organogramState.dragStart.mouseY) / scale;

                card.style.left = `${newLeft}px`;
                card.style.top = `${newTop}px`;
                drawConnections(); // Redraw connections as card moves
            }
        }

        function handleGlobalMouseUp(e) {
            if (organogramState.isDraggingCard && organogramState.activeCardId) {
                const card = document.getElementById(organogramState.activeCardId);

                // The card position is already updated by handleGlobalMouseMove.
                // Triggers collision resolution on the final position.
                resolveCardCollision(card);

                drawConnections();

                card.classList.remove('z-50');
                organogramState.isDraggingCard = false;
                organogramState.activeCardId = null;
                organogramState.dragStart = null; // Clear card drag state

            } else if (organogramState.isDraggingConnection) {
                const tempLine = document.getElementById('temp-connection-line');
                if (tempLine) tempLine.remove();

                const targetHitArea = e.target.closest('.conn-hit-area');
                if (targetHitArea) {
                    const targetCard = targetHitArea.closest('[id^="card-"]');
                    if (targetCard && targetCard.id !== organogramState.connectionStartId) {
                        // Only create if dropping on IN (top) generally, or just allow any for now
                        const isTargetIn = targetHitArea.classList.contains('connection-dot-in');
                        if (isTargetIn) {
                            createConnection(organogramState.connectionStartId, targetCard.id);
                        }
                    }
                }

                organogramState.isDraggingConnection = false;
                organogramState.connectionStartId = null;
                organogramState.dragStartPoint = null;
            }

            // Reset
            organogramState.isDraggingCard = false;
            organogramState.isDraggingCanvas = false;
            organogramState.activeCardId = null;
            document.body.style.cursor = 'default';

            // Save State after interaction
            saveState();

            organogramState.isDraggingCanvas = false;
            document.getElementById('organogram-container').classList.remove('cursor-grabbing');
        }

        // --- Collision Logic (Snap to Edge) ---
        function resolveCardCollision(card) {
            const margin = 20; // Visual gap
            const maxIterations = 5;
            let iterations = 0;

            // We try to move the card to the NEAREST non-overlapping position
            // relative to the card it is colliding with.

            while (iterations < maxIterations) {
                const cardRect = card.getBoundingClientRect();
                let overlap = null;

                const allCards = document.querySelectorAll('[id^="card-"]');
                for (const other of allCards) {
                    if (other.id === card.id) continue;
                    const otherRect = other.getBoundingClientRect();

                    if (isOverlapping(cardRect, otherRect, margin)) {
                        overlap = otherRect;
                        break;
                    }
                }

                if (!overlap) break; // No collision

                // Calculate distances to all 4 edges of the overlapped card
                // We want to snap to the closest side: Left, Right, Top, or Bottom.

                // Current logical coords (approx, based on scale)
                const currentLeft = parseFloat(card.style.left);
                const currentTop = parseFloat(card.style.top);
                const w = 288; // w-72
                const h = 180; // h-[180px]

                // Option 1: Snap to Right
                // Target Left = Other.Right + Margin
                // We need to map "Other.Right" from viewport to logical space...
                // Simpler approach: Calculate overlap amount in each direction relative to CENTERS

                const cardCx = cardRect.left + cardRect.width / 2;
                const cardCy = cardRect.top + cardRect.height / 2;
                const otherCx = overlap.left + overlap.width / 2;
                const otherCy = overlap.top + overlap.height / 2;

                const dx = cardCx - otherCx;
                const dy = cardCy - otherCy;

                // Normalize by dimensions to see which axis is "more overlapping" relative to shape
                const rX = dx / cardRect.width;
                const rY = dy / cardRect.height;

                // Dominant axis determines snap direction
                if (Math.abs(rX) > Math.abs(rY)) {
                    // Horizontal Snap
                    if (dx > 0) {
                        // Move to Right
                        // Logic: position = Current + (OverlapAmount + Margin)
                        // But we don't know logical overlap easily.
                        // Easier: Just shove it by fixed amount? No, user wants "Minimal consistent"
                        // Let's rely on direction. 
                        // New Left should be such that Card.Left = Other.OriginalLeft + Width + Margin
                        // We need to find the "Other" card's logical position.
                        const otherEl = document.elementFromPoint(otherCx, otherCy)?.closest('[id^="card-"]');
                        if (otherEl) {
                            const oLeft = parseFloat(otherEl.style.left);
                            card.style.left = `${oLeft + w + margin}px`;
                        } else {
                            // Fallback
                            card.style.left = `${currentLeft + w}px`;
                        }
                    } else {
                        // Move to Left
                        const otherEl = document.elementFromPoint(otherCx, otherCy)?.closest('[id^="card-"]');
                        if (otherEl) {
                            const oLeft = parseFloat(otherEl.style.left);
                            card.style.left = `${oLeft - w - margin}px`;
                        } else {
                            card.style.left = `${currentLeft - w}px`;
                        }
                    }
                } else {
                    // Vertical Snap
                    if (dy > 0) {
                        // Move Down
                        const otherEl = document.elementFromPoint(otherCx, otherCy)?.closest('[id^="card-"]');
                        if (otherEl) {
                            const oTop = parseFloat(otherEl.style.top);
                            card.style.top = `${oTop + h + margin}px`;
                        } else {
                            card.style.top = `${currentTop + h}px`;
                        }
                    } else {
                        // Move Up
                        const otherEl = document.elementFromPoint(otherCx, otherCy)?.closest('[id^="card-"]');
                        if (otherEl) {
                            const oTop = parseFloat(otherEl.style.top);
                            card.style.top = `${oTop - h - margin}px`;
                        } else {
                            card.style.top = `${currentTop - h}px`;
                        }
                    }
                }

                iterations++;
            }
        }

        function isOverlapping(rect1, rect2, margin = 0) {
            // Check if rect1 intersects rect2 with some margin
            // Expand rect2 by margin effectively
            return !(rect1.right < rect2.left - margin ||
                rect1.left > rect2.right + margin ||
                rect1.bottom < rect2.top - margin ||
                rect1.top > rect2.bottom + margin);
        }

        function createConnection(fromId, toId) {
            const exists = organogramState.connections.find(c => c.from === fromId && c.to === toId);
            if (exists) return;

            organogramState.connections.push({
                id: `conn-${Date.now()}`,
                from: fromId,
                to: toId
            });
            drawConnections();
        }

        function updateOrganogramTransform() {
            const content = document.getElementById('organogram-content');
            if (content) {
                content.style.transform = `translate(${organogramState.pan.x}px, ${organogramState.pan.y}px) scale(${organogramState.scale})`;
            }
        }

        function zoomOrganogram(delta) {
            organogramState.scale += delta;
            if (organogramState.scale < 0.2) organogramState.scale = 0.2;
            if (organogramState.scale > 3) organogramState.scale = 3;
            updateOrganogramTransform();
        }

        function fitOrganogram() {
            // Reset individual card positions to default "Tree" layout
            const positions = {
                'card-ceo': { l: 0, t: -200 },
                'card-traffic': { l: -500, t: 100 },
                'card-copy': { l: -170, t: 100 },
                'card-content': { l: 170, t: 100 },
                'card-sales': { l: 500, t: 100 }
            };

            Object.keys(positions).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.style.left = positions[id].l + 'px';
                    el.style.top = positions[id].t + 'px';
                }
            });

            centerContent();
            drawConnections();
        }

        function centerContent() {
            const cards = document.querySelectorAll('[id^="card-"]');
            if (cards.length === 0) return;

            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;

            cards.forEach(card => {
                const left = parseFloat(card.style.left) || 0;
                const top = parseFloat(card.style.top) || 0;
                // Assuming w-72 (288px) and h-[180px] (180px)
                // For robustness, could use getBoundingClientRect but that depends on current transform/scale
                // Using raw style left/top is safer for the "logical" content plane
                const width = 288;
                const height = 180;

                if (left < minX) minX = left;
                if (top < minY) minY = top;
                if (left + width > maxX) maxX = left + width;
                if (top + height > maxY) maxY = top + height;
            });

            const contentWidth = maxX - minX;
            const contentHeight = maxY - minY;
            const contentCenterX = minX + contentWidth / 2;
            const contentCenterY = minY + contentHeight / 2;

            const container = document.getElementById('organogram-container');
            const containerRect = container.getBoundingClientRect();

            // Auto-fit scale
            const padding = 40;
            const availableW = containerRect.width - padding * 2;
            const availableH = containerRect.height - padding * 2;

            let targetScale = 1;
            if (contentWidth > 0 && contentHeight > 0) {
                const scaleX = availableW / contentWidth;
                const scaleY = availableH / contentHeight;
                targetScale = Math.min(scaleX, scaleY, 1); // Ensure we don't zoom in excessively, but 1 is fine standard
                // Limit min scale
                if (targetScale < 0.4) targetScale = 0.4;
            }

            organogramState.scale = targetScale;

            // Pan to center: 
            // ContainerCenter = Pan + ContentCenter * Scale
            // Pan = ContainerCenter - ContentCenter * Scale
            organogramState.pan.x = (containerRect.width / 2) - (contentCenterX * organogramState.scale);
            organogramState.pan.y = (containerRect.height / 2) - (contentCenterY * organogramState.scale);

            updateOrganogramTransform();
        }

        function drawConnections() {
            const svg = document.getElementById('connections-layer');
            if (!svg) return;

            svg.innerHTML = '';

            organogramState.connections.forEach(conn => {
                const startPos = getDotCenter(conn.from, 'out');
                const endPos = getDotCenter(conn.to, 'in');

                if (!startPos || !endPos) return;

                const x1 = startPos.x;
                const y1 = startPos.y;
                const x2 = endPos.x;
                const y2 = endPos.y;

                // Bezier
                const cp1x = x1;
                const cp1y = y1 + 50;
                const cp2x = x2;
                const cp2y = y2 - 50;

                const pathData = `M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`;

                // Group
                const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
                // pointer-events-auto ensures the group children catch events
                group.setAttribute("class", "connection-group pointer-events-auto");

                // Strict Hover Logic via JS
                group.onmouseenter = function () {
                    const icon = this.querySelector('.trash-icon-container');
                    if (icon) {
                        icon.classList.remove('opacity-0', 'pointer-events-none');
                        icon.classList.add('opacity-100', 'pointer-events-auto');
                    }
                };
                group.onmouseleave = function () {
                    const icon = this.querySelector('.trash-icon-container');
                    if (icon) {
                        icon.classList.remove('opacity-100', 'pointer-events-auto');
                        icon.classList.add('opacity-0', 'pointer-events-none');
                    }
                };

                const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
                path.setAttribute("d", pathData);
                path.setAttribute("fill", "none");
                path.setAttribute("stroke", "#cbd5e1");
                path.setAttribute("stroke-width", "2");
                path.setAttribute("class", "transition-colors duration-200"); // Removed group-hover color change to keep it simple or add via JS if needed

                // Hit Area (thicker, invisible)
                const hitPath = document.createElementNS("http://www.w3.org/2000/svg", "path");
                hitPath.setAttribute("d", pathData);
                hitPath.setAttribute("fill", "none");
                hitPath.setAttribute("stroke", "transparent");
                hitPath.setAttribute("stroke-width", "20");
                hitPath.setAttribute("class", "cursor-pointer");

                // Trash Icon
                const t = 0.5;
                const midX = (1 - t) * (1 - t) * (1 - t) * x1 + 3 * (1 - t) * (1 - t) * t * cp1x + 3 * (1 - t) * t * t * cp2x + t * t * t * x2;
                const midY = (1 - t) * (1 - t) * (1 - t) * y1 + 3 * (1 - t) * (1 - t) * t * cp1y + 3 * (1 - t) * t * t * cp2y + t * t * t * y2;

                const deleteIcon = document.createElementNS("http://www.w3.org/2000/svg", "foreignObject");
                deleteIcon.setAttribute("x", midX - 10);
                deleteIcon.setAttribute("y", midY - 10);
                deleteIcon.setAttribute("width", "20");
                deleteIcon.setAttribute("height", "20");
                // Initially hidden, controlled by JS events on group
                deleteIcon.setAttribute("class", "trash-icon-container opacity-0 pointer-events-none transition-opacity duration-200");

                deleteIcon.innerHTML = `
                    <div class="w-5 h-5 bg-white rounded-full flex items-center justify-center border border-red-200 shadow-sm cursor-pointer hover:bg-red-50"
                         onclick="deleteConnection('${conn.id}'); event.stopPropagation();">
                        <i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i>
                    </div>`;

                group.appendChild(path);
                group.appendChild(hitPath);
                group.appendChild(deleteIcon);
                svg.appendChild(group);
            });

            if (window.lucide) activeIcons = lucide.createIcons();
        }

        // Make globally available for inline onclick handlers
        window.deleteConnection = function (connId) {
            console.log("Deleting connection:", connId); // Debug log
            organogramState.connections = organogramState.connections.filter(c => c.id !== connId);
            drawConnections();
            saveState(); // Save after connection/line delete
        };

        // --- Card Actions ---
        function previewAgent(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            // Extract data from logic (or simulation)
            const name = card.querySelector('[data-field="name"]').innerText;
            const desc = card.querySelector('[data-field="desc"]').innerText;
            const provider = card.querySelector('[data-field="provider"]').innerText;
            const model = card.querySelector('[data-field="model"]').innerText;

            alert(`PREVIEW AGENTE:\n\nNome: ${name}\nProvider: ${provider}\nModelo: ${model}\n\n${desc}`);
        }

        function editAgent(cardId) {
            const card = document.getElementById(cardId);
            if (!card) return;

            // Store ID
            organogramState.editingAgentId = cardId;

            // Extract data
            const name = card.querySelector('[data-field="name"]').innerText;
            const desc = card.querySelector('[data-field="desc"]').innerText;
            let provider = card.querySelector('[data-field="provider"]').innerText.toLowerCase();
            let model = card.querySelector('[data-field="model"]').innerText;

            // Normalize provider if needed (handle visual text vs value)
            const providerSelect = document.getElementById('agent-provider');
            // Try to match text to value, or default to openai
            if (!['openai', 'anthropic', 'google'].includes(provider)) provider = 'openai';

            // Populate Modal
            document.getElementById('agent-name').value = name;
            document.getElementById('agent-desc').value = desc;
            document.getElementById('agent-slug').value = cardId.replace('card-', '').split('-')[0]; // Simple slug recovery
            document.getElementById('agent-provider').value = provider;

            // Update models then set model
            updateModelOptions();

            // Try to set model if it exists in options
            const modelSelect = document.getElementById('agent-model');
            // If model text is just the name, we might need value. But here we assume text match or ID match.
            // Let's iterate options to find a match by text or value
            for (let i = 0; i < modelSelect.options.length; i++) {
                if (modelSelect.options[i].text === model || modelSelect.options[i].value === model) {
                    modelSelect.selectedIndex = i;
                    break;
                }
            }

            // Change Save Button Text
            const saveBtn = document.querySelector('#agent-modal button[onclick="saveAgent()"]');
            if (saveBtn) saveBtn.innerHTML = '<i data-lucide="save" class="w-4 h-4 mr-2"></i> Salvar Alterações';

            openAgentModal(true); // pass true to skip clearing
        }

        function deleteAgent(cardId) {
            if (confirm('Tem certeza que deseja excluir este agente e suas conexões?')) {
                const el = document.getElementById(cardId);
                if (el) el.remove();

                // Remove connections
                organogramState.connections = organogramState.connections.filter(c => c.from !== cardId && c.to !== cardId);
                drawConnections();
                saveState(); // Save after agent delete
            }
        }

        function openAgentModal(isEdit = false) {
            const modal = document.getElementById('agent-modal');
            const content = document.getElementById('agent-modal-content');

            if (!modal || !content) { console.error('Modal not found'); return; }

            if (!isEdit) {
                // Reset for Create Mode
                organogramState.editingAgentId = null;
                document.getElementById('agent-name').value = '';
                document.getElementById('agent-slug').value = '';
                document.getElementById('agent-desc').value = '';
                document.getElementById('agent-provider').value = 'openai';
                updateModelOptions();

                const saveBtn = document.querySelector('#agent-modal button[onclick="saveAgent()"]');
                if (saveBtn) saveBtn.innerHTML = '<i data-lucide="check" class="w-4 h-4 mr-2"></i> Criar Agente';
            }

            modal.classList.remove('hidden');
            // Animate in
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                content.classList.remove('scale-95', 'opacity-0');
                content.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        function closeAgentModal() {
            const modal = document.getElementById('agent-modal');
            const content = document.getElementById('agent-modal-content');

            if (!modal || !content) return;

            content.classList.remove('scale-100', 'opacity-100');
            content.classList.add('scale-95', 'opacity-0');
            modal.classList.add('opacity-0');

            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        function updateModelOptions() {
            const provider = document.getElementById('agent-provider').value;
            const modelSelect = document.getElementById('agent-model');
            const models = AGENT_MODELS[provider] || [];

            modelSelect.innerHTML = models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        function saveAgent() {
            // Get values
            const name = document.getElementById('agent-name').value;
            const slug = document.getElementById('agent-slug').value;
            const provider = document.getElementById('agent-provider').value;
            const model = document.getElementById('agent-model').value; // Get selected model
            const desc = document.getElementById('agent-desc').value;

            if (!name || !slug) {
                alert('Nome e Slug são obrigatórios.');
                return;
            }

            if (organogramState.editingAgentId) {
                // UPDATE EXISTING
                const card = document.getElementById(organogramState.editingAgentId);
                if (card) {
                    card.querySelector('[data-field="name"]').textContent = name;
                    card.querySelector('[data-field="desc"]').textContent = desc;
                    card.querySelector('[data-field="provider"]').textContent = provider;
                    card.querySelector('[data-field="model"]').textContent = model; // Use ID or Name? Usually ID for logic, Name for display.
                    // Let's use the text from the option for display
                    const modelSelect = document.getElementById('agent-model');
                    const modelName = modelSelect.options[modelSelect.selectedIndex].text;
                    card.querySelector('[data-field="model"]').textContent = modelName;

                    // Show success on Save Button
                    const saveBtn = document.querySelector('#agent-modal button[onclick="saveAgent()"]');
                    if (saveBtn) {
                        const originalText = saveBtn.innerHTML;
                        saveBtn.innerHTML = `<i data-lucide="check" class="w-4 h-4 mr-2"></i> Salvo!`;
                        setTimeout(() => {
                            saveBtn.innerHTML = originalText;
                            closeAgentModal();
                        }, 1000);
                    } else {
                        closeAgentModal();
                    }
                    saveState(); // Save after update existing
                }
            } else {
                // CREATE NEW
                closeAgentModal();

                // Show Success Notification on "New Agent" button
                const btn = document.querySelector('#view-agents button[onclick*="openAgentModal"]');
                if (btn) {
                    const originalText = btn.innerHTML;
                    btn.innerHTML = `<i data-lucide="check" class="w-4 h-4 mr-2"></i> Criado!`;
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        if (window.lucide) lucide.createIcons();
                    }, 2000);
                }

                // Pass an object with all data
                // For model text
                const modelSelect = document.getElementById('agent-model');
                const modelName = modelSelect.options[modelSelect.selectedIndex].text;
                appendAgentToGrid({ name, slug, provider, model: modelName, desc });
                // appendAgentToGrid now calls saveState() internally or we call it here? 
                // Let's ensure appendAgentToGrid calls it OR call it here.
                // Better to call here if appendAgentToGrid is pure DOM.
                // But appendAgentToGrid might be async or used by loadState (which shouldn't save).
                // Let's check appendAgentToGrid signature.
            }
        }

        function appendAgentToGrid(data) {
            const container = document.getElementById('organogram-content');
            if (!container) {
                console.warn("Organogram container not found");
                return;
            }

            // Create unique ID
            const validSlug = data.slug.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
            const cardId = `card-${validSlug}-${Date.now()}`;

            const card = document.createElement('div');
            // Updated to w-72 for consistency
            card.className = 'absolute z-10 w-72 group animate-in fade-in zoom-in duration-500';
            card.id = cardId;
            card.style.left = '0px';
            card.style.top = '100px';

            card.innerHTML = `
                <!-- Input Connection Area (Top) -->
                <div class="conn-hit-area top-point connection-dot-in">
                     <div class="conn-dot"></div>
                </div>
                
                <!-- Output Connection Area (Bottom) -->
                <div class="conn-hit-area bottom-point connection-dot-out"
                     onmousedown="handleDotMouseDown(event, '${cardId}')">
                     <div class="conn-dot"></div>
                </div>

                <div class="bg-white p-3 rounded-lg shadow-sm border border-slate-200 hover:shadow-lg transition-all duration-300 hover:border-orange-200 h-[180px] flex flex-col justify-between">
                    <div class="flex items-start gap-3">
                        <div class="w-8 h-8 rounded bg-orange-50 flex items-center justify-center shrink-0">
                            <i data-lucide="bot" class="w-4 h-4 text-orange-600"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center justify-between mb-1 gap-2">
                                <h3 class="font-bold text-slate-800 text-sm truncate" data-field="name">${data.name}</h3>
                                <span class="px-1.5 py-0.5 rounded-full bg-orange-500 text-white text-[9px] font-bold uppercase shrink-0">Ativo</span>
                            </div>
                            <p class="text-[10px] text-slate-500 leading-snug mb-1 line-clamp-3" data-field="desc">${data.desc}</p>
                            <div class="flex gap-1 mb-1 flex-wrap">
                                <span class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded" data-field="provider">${data.provider}</span>
                                <span class="text-[9px] font-semibold text-slate-500 bg-slate-100 px-1.5 py-0.5 rounded" data-field="model">${data.model}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 text-slate-400 border-t border-slate-100 pt-2 mt-auto">
                        <button class="hover:text-orange-500" onclick="previewAgent('${cardId}')"><i data-lucide="eye" class="w-3 h-3"></i></button>
                        <button class="hover:text-orange-500" onclick="editAgent('${cardId}')"><i data-lucide="settings" class="w-3 h-3"></i></button>
                        <button class="hover:text-red-500" onclick="deleteAgent('${cardId}')"><i data-lucide="trash-2" class="w-3 h-3"></i></button>
                    </div>
                </div>`;

            // Attach Drag Event (Card Body) mostly handled by global logic, but we need to ensure card is targetable
            card.addEventListener('mousedown', handleCardMouseDown);

            container.appendChild(card);

            // Auto-connect removed for manual testing, OR keep if user wants default. 
            // User requested manual connections, so I won't auto-connect newly created agents to keep lines clean unless requested.
            // But previous requirement often implies hierarchy. I'll comment it out for "Drag to Connect" purity.
            // organogramState.connections.push({...}); 
            // Better: Let user connect.

            // Attach Touch Events dynamically for new card
            card.addEventListener('touchstart', (e) => {
                const t = e.touches[0];
                handleCardMouseDown({
                    clientX: t.clientX,
                    clientY: t.clientY,
                    currentTarget: card,
                    stopPropagation: () => e.stopPropagation(),
                    target: e.target,
                    closest: (s) => e.target.closest(s),
                    preventDefault: () => { }
                });
            }, { passive: false });

            const dotOut = card.querySelector('.connection-dot-out');
            if (dotOut) {
                dotOut.addEventListener('touchstart', (e) => {
                    e.stopPropagation(); e.preventDefault();
                    handleDotMouseDown({
                        stopPropagation: () => { },
                        preventDefault: () => { }
                    }, cardId);
                }, { passive: false });
            }

            if (window.lucide) lucide.createIcons();
        }


        // --- Navigation Logic and setActiveSubItem were duplicated here and have been removed ---


        function setActiveSubItem(el) {
            // Reset all subitems
            const subitems = document.querySelectorAll('#dashboard-submenu a, #time-submenu a');
            subitems.forEach(item => {
                item.classList.remove('text-white');
                item.classList.add('text-slate-400');
                // Reset dot
                const dot = item.querySelector('span.w-1\\.5');
                if (dot) {
                    dot.classList.remove('bg-red-500');
                    dot.classList.add('bg-slate-600');
                }
            });

            // Set Active
            el.classList.remove('text-slate-400');
            el.classList.add('text-white');
            const dot = el.querySelector('span.w-1\\.5');
            if (dot) {
                dot.classList.remove('bg-slate-600');
                dot.classList.add('bg-red-500');
            }

            // Parent is active by default in this view
        }

        // --- DAILY DATA STRUCTURE (RESTORED) ---
        // DAILY_DATA is already declared above.


        function initDailyData() {
            DAILY_DATA = [];
            const today = new Date();
            // Generate last 365 days backbone (Increased from 90 to support longer views)
            for (let i = 0; i < 365; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() - i);
                d.setHours(0, 0, 0, 0); // Normalize to midnight for matching

                // Base Structure
                DAILY_DATA.push({
                    date: d,
                    // "all" aggregate
                    all: { investment: 0, revenue: 0, participants: 0, vips: 0, indiv: 0, double: 0 },
                    // Campaign specific slots (defaults)
                    consultoria: { investment: 0, revenue: 0, participants: 0 },
                    curso_ia: { investment: 0, revenue: 0, participants: 0 }
                });
            }
        }
        // Run immediately
        initDailyData();

        // --- MOCK SALES DATA GENERATOR ---
        // --- SUPABASE INTEGRATION ---
        const SUPABASE_URL = 'https://bqlhtbzgsmpqqtyihizt.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_gNomZc5mY5wX5igc_KHpfQ_hFN8ci92';
        // let supabase = null; // DUPLICATE: Declared earlier/elsewhere

        // Initialize Supabase safely
        if (window.supabase) {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        } else {
            console.warn("Supabase SDK not loaded yet. Waiting...");
            // Polling backup
            const checkSupabase = setInterval(() => {
                if (window.supabase) {
                    clearInterval(checkSupabase);
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                    generateSalesData(); // Trigger fetch once ready
                }
            }, 500);
        }

        let ALL_SALES = [];
        // Default range (will be adjusted by filter)
        let salesStartDate = new Date();
        salesStartDate.setDate(salesStartDate.getDate() - 7);
        let salesEndDate = new Date();

        async function generateSalesData() {
            if (!supabase) {
                console.warn("Supabase client not ready.");
                return;
            }

            console.log("[Supabase] Fetching real sales...");
            try {
                const { data, error } = await supabase
                    .from('sales')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Process Sales
                ALL_SALES = data.map(s => {
                    const d = new Date(s.created_at);
                    return {
                        id: s.id,
                        external_id: s.external_id,
                        rawDate: d,
                        dateStr: d.toLocaleDateString('pt-BR'),
                        name: s.customer_name || 'Cliente Desconhecido',
                        email: s.customer_email || 'nao_informado',
                        product: s.product_name || 'Produto Padrão',
                        paymentMethod: s.payment_method || '-',
                        status: s.status || 'Pendente',
                        value: parseFloat(s.value || 0)
                    };
                });

                console.log(`[Supabase] Loaded ${ALL_SALES.length} sales.`);
                // DEBUG: Prove count to user
                // alert(`DEBUG: Supabase retornou ${ALL_SALES.length} vendas.`);

                // Re-calculate DAILY_DATA for the Charts/KPIs
                recalcDailyDataFromSales();

                // Refresh UI
                if (typeof renderSalesTable === 'function') renderSalesTable(true);
                if (typeof renderRecentSalesWidget === 'function') renderRecentSalesWidget();
                if (typeof refreshDashboard === 'function') refreshDashboard();

            } catch (err) {
                console.error("[Supabase] Error:", err);
            }
        }

        function recalcDailyDataFromSales() {
            // Reset daily counts (keep investment from FB)
            DAILY_DATA.forEach(d => {
                // Keep d.all.investment
                // Reset revenue metrics
                const resetMetrics = (obj) => {
                    obj.revenue = 0; obj.participants = 0; obj.vips = 0; obj.indiv = 0; obj.double = 0;
                };

                resetMetrics(d.all);
                d.products = {}; // Reset product map completely

                // Also reset campaign revenue metrics if they exist
                Object.keys(d).forEach(key => {
                    if (key !== 'date' && key !== 'all' && key !== 'products' && typeof d[key] === 'object') {
                        resetMetrics(d[key]);
                    }
                });
            });

            // Iterate Real Sales
            const productsSet = new Set();

            let debugTotal = 0;
            let debugApproved = 0;
            // let debugMappedToday = 0;

            ALL_SALES.forEach(sale => {
                debugTotal++;
                // Collect Product Name (Trimmed)
                const pName = sale.product ? sale.product.trim() : 'Produto Padrão';
                if (pName) productsSet.add(pName);

                const cleanStatus = sale.status ? sale.status.trim().toLowerCase() : '';

                // FILTRO DE STATUS: Apenas Aprovado (Robust Match)
                if (!cleanStatus.includes('aprovado')) {
                    return;
                }
                debugApproved++;

                // Find Day
                const saleDate = new Date(sale.rawDate);
                saleDate.setHours(0, 0, 0, 0);

                const checkDateStr = saleDate.toDateString();
                const dayData = DAILY_DATA.find(d => d.date.toDateString() === checkDateStr);

                if (dayData) {
                    // Determine Participants Count (Duplo = 2)
                    let pCount = 1;
                    if (pName.toLowerCase().includes('duplo')) pCount = 2;

                    // Aggregate Global
                    dayData.all.revenue += sale.value;
                    dayData.all.participants += pCount;
                    dayData.all.salesCount = (dayData.all.salesCount || 0) + 1;

                    if (pName.toLowerCase().includes('vip')) dayData.all.vips += pCount;
                    else if (pName.toLowerCase().includes('duplo')) dayData.all.double += pCount;
                    else dayData.all.indiv += pCount;

                    // Aggregate Product Specific
                    if (!dayData.products[pName]) {
                        dayData.products[pName] = { investment: 0, revenue: 0, participants: 0, salesCount: 0, vips: 0, indiv: 0, double: 0 };
                    }
                    const pData = dayData.products[pName];
                    pData.revenue += sale.value;
                    pData.participants += pCount;
                    pData.salesCount = (pData.salesCount || 0) + 1;

                    if (pName.toLowerCase().includes('vip')) pData.vips += pCount;
                    else if (pName.toLowerCase().includes('duplo')) pData.double += pCount;
                    else pData.indiv += pCount;
                }
            });

            // DEBUG ALERT (Temporary)
            // alert(`DEBUG VENDAS:\nTotal Encontradas: ${debugTotal}\nTotal Aprovadas (Filtro): ${debugApproved}\n\nVerifique se o número de Aprovadas bate com o esperado.`);

            // Update UI Dropdown
            const select = document.getElementById('product-select');
            if (select) {
                // Keep 'all' option
                select.innerHTML = '<option value="all">Todos os produtos</option>';
                productsSet.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p;
                    opt.innerText = p;
                    select.appendChild(opt);
                });
                // Restore selection if needed
                select.value = selectedProductName;
            }

            console.log("Recalculated Daily Data with Products:", DAILY_DATA);
            refreshDashboard();
        }

        function updateSelectedProduct(val) {
            console.log("Product Filter Changed:", val);
            selectedProductName = val;
            refreshDashboard();
        }



        // Removed createMockSale function as it is no longer needed.

        // --- SALES DATE PICKER LOGIC (Advanced) ---
        let salesCurrentMonth = 0; // Jan
        let salesCurrentYear = 2026;

        function toggleSalesDatePicker() {
            const d = document.getElementById('salesDatePickerDropdown');
            if (d) d.classList.toggle('hidden');
            if (!d.classList.contains('hidden')) {
                // Initialize view when opening
                salesCurrentMonth = salesStartDate ? salesStartDate.getMonth() : new Date().getMonth();
                salesCurrentYear = salesStartDate ? salesStartDate.getFullYear() : new Date().getFullYear();
                renderSalesCalendars();
                updateSalesDateInputs();
            }
        }

        function renderSalesCalendars() {
            renderSalesMonth(salesCurrentYear, salesCurrentMonth, 'sales-cal-container-1', 'sales-cal-title-1');
            let nextMonth = salesCurrentMonth + 1;
            let nextYear = salesCurrentYear;
            if (nextMonth > 11) { nextMonth = 0; nextYear++; }
            renderSalesMonth(nextYear, nextMonth, 'sales-cal-container-2', 'sales-cal-title-2');
        }

        function renderSalesMonth(year, month, containerId, titleId) {
            const container = document.getElementById(containerId);
            const title = document.getElementById(titleId);
            if (!container || !title) return;

            title.innerText = `${monthNames[month]} ${year}`;
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';
            for (let i = 0; i < firstDay; i++) { html += `<div></div>`; }

            for (let d = 1; d <= daysInMonth; d++) {
                const currentDate = new Date(year, month, d);
                // Normalize
                const normCurrentDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), currentDate.getDate());
                const normSelectedStartDate = salesStartDate ? new Date(salesStartDate.getFullYear(), salesStartDate.getMonth(), salesStartDate.getDate()) : null;
                const normSelectedEndDate = salesEndDate ? new Date(salesEndDate.getFullYear(), salesEndDate.getMonth(), salesEndDate.getDate()) : null;

                let classes = "p-1 cursor-pointer rounded-full transition-colors flex items-center justify-center h-8 w-8 mx-auto ";
                let isStart = normSelectedStartDate && normCurrentDate.getTime() === normSelectedStartDate.getTime();
                let isEnd = normSelectedEndDate && normCurrentDate.getTime() === normSelectedEndDate.getTime();
                let isInRange = normSelectedStartDate && normSelectedEndDate && normCurrentDate > normSelectedStartDate && normCurrentDate < normSelectedEndDate;

                if (isStart || isEnd) {
                    classes += "bg-blue-600 text-white font-medium hover:bg-blue-700";
                } else if (isInRange) {
                    classes += "bg-blue-50 text-blue-700 hover:bg-blue-100 rounded-none";
                } else {
                    classes += "hover:bg-slate-100 text-slate-700";
                }
                html += `<div class="${classes}" onclick="handleSalesDateClick(${d}, ${month}, ${year})">${d}</div>`;
            }
            container.innerHTML = html;
        }

        function changeSalesMonth(delta) {
            salesCurrentMonth += delta;
            if (salesCurrentMonth > 11) { salesCurrentMonth = 0; salesCurrentYear++; }
            if (salesCurrentMonth < 0) { salesCurrentMonth = 11; salesCurrentYear--; }
            renderSalesCalendars();
        }

        function handleSalesDateClick(d, m, y) {
            const clickedDate = new Date(y, m, d);
            if (!salesStartDate || (salesStartDate && salesEndDate)) {
                salesStartDate = clickedDate;
                salesEndDate = null;
            } else {
                if (clickedDate < salesStartDate) {
                    salesEndDate = salesStartDate;
                    salesStartDate = clickedDate;
                } else {
                    salesEndDate = clickedDate;
                }
            }
            renderSalesCalendars();
            updateSalesDateInputs();
        }

        function updateSalesDateInputs() {
            const startEl = document.getElementById('sales-input-start');
            const endEl = document.getElementById('sales-input-end');
            if (startEl) startEl.innerText = salesStartDate ? salesStartDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
            if (endEl) endEl.innerText = salesEndDate ? salesEndDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' }) : '-';
        }

        function applySalesDateSelection() {
            if (salesStartDate && salesEndDate) {
                const s = salesStartDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                const e = salesEndDate.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                document.getElementById('salesDateRangeLabel').innerText = `${s} - ${e}`;
                document.getElementById('salesDatePickerDropdown').classList.add('hidden');

                // Logic to sync radio buttons based on dates
                // (Skipping detailed radio sync for brevity unless critical, but "Today" functionality relies on dates matching)

                renderSalesTable();
            }
        }

        // Initialize Sales Presets Listener
        setTimeout(() => {
            const salesPresets = document.querySelectorAll('input[name="salesDatePreset"]');
            salesPresets.forEach((radio, index) => {
                radio.addEventListener('change', (e) => {
                    // 1. Get Dates
                    const { start, end } = getPresetDates(presetMap[index]); // Reusing presetMap/getPresetDates from global scope
                    salesStartDate = start;
                    salesEndDate = end;
                    // 2. UI
                    salesCurrentYear = salesStartDate.getFullYear();
                    salesCurrentMonth = salesStartDate.getMonth();
                    renderSalesCalendars();
                    updateSalesDateInputs();
                    // 3. Label
                    document.getElementById('salesDateRangeLabel').innerText = labelMap[index]; // reusing labelMap
                    // 4. Close & Render
                    document.getElementById('salesDatePickerDropdown').classList.add('hidden');
                    renderSalesTable();

                    // Visual Selection Logic
                    salesPresets.forEach(p => p.parentElement.classList.remove('bg-blue-50', 'text-blue-700', 'font-medium'));
                    radio.parentElement.classList.add('bg-blue-50', 'text-blue-700', 'font-medium');
                });
            });
        }, 500); // Delay to ensure DOM exists or call in initApp

        // --- Sales Table Logic ---
        let salesPage = 1;
        let salesPageSize = 10;

        function showMetadataLoading(callback) {
            const overlay = document.getElementById('table-loading-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }

            // Simulate network delay
            setTimeout(() => {
                callback();
                if (overlay) {
                    overlay.classList.add('hidden');
                    overlay.classList.remove('flex');
                }
            }, 600); // 600ms delay
        }

        function changeSalesPage(delta) {
            showMetadataLoading(() => {
                salesPage += delta;
                renderSalesTable();
            });
        }

        function changeSalesPageSize(size) {
            showMetadataLoading(() => {
                salesPageSize = parseInt(size);
                renderSalesTable(true);
            });
        }

        function renderSalesTable(resetPage = false) {
            const tbody = document.getElementById('sales-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';

            const searchInput = document.getElementById('sales-search');
            const statusFilterInput = document.getElementById('sales-status-filter');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const statusFilter = statusFilterInput ? statusFilterInput.value : 'all';

            // Reset page if searching (heuristic)
            if (resetPage) salesPage = 1;

            const filtered = ALL_SALES.filter(sale => {
                if (sale.rawDate < salesStartDate || sale.rawDate > salesEndDate) return false;
                if (statusFilter !== 'all' && sale.status !== statusFilter) return false;
                if (search && !sale.name.toLowerCase().includes(search) && !sale.email.toLowerCase().includes(search)) return false;
                return true;
            });

            // Pagination Logic
            const total = filtered.length;
            const maxPage = Math.ceil(total / salesPageSize) || 1;
            if (salesPage > maxPage) salesPage = maxPage;
            if (salesPage < 1) salesPage = 1;

            const startIndex = (salesPage - 1) * salesPageSize;
            const endIndex = Math.min(startIndex + salesPageSize, total);
            const paged = filtered.slice(startIndex, startIndex + salesPageSize);

            // Update Info & Buttons
            const paginationInfo = document.getElementById('sales-pagination-info');
            const prevBtn = document.getElementById('sales-prev-btn');
            const nextBtn = document.getElementById('sales-next-btn');

            if (paginationInfo) {
                if (total === 0) {
                    paginationInfo.innerText = '0 resultados';
                } else {
                    paginationInfo.innerText = `Mostrando ${startIndex + 1} - ${endIndex} de ${total} resultados`;
                }
            }

            if (prevBtn) prevBtn.disabled = salesPage <= 1;
            if (nextBtn) nextBtn.disabled = salesPage >= maxPage;

            if (paged.length === 0 && total === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="px-6 py-8 text-center text-slate-500">Nenhuma venda encontrada para este período.</td></tr>`;
                return;
            }

            paged.forEach(sale => {
                let statusBadge = '';
                if (sale.status === 'Aprovado') statusBadge = `<span class="bg-emerald-50 text-emerald-700 border border-emerald-100 px-2 py-0.5 rounded-full text-xs font-medium flex items-center w-max"><i data-lucide="check-circle" class="w-3 h-3 mr-1"></i> Aprovado</span>`;
                else if (sale.status === 'Pendente') statusBadge = `<span class="bg-amber-50 text-amber-700 border border-amber-100 px-2 py-0.5 rounded-full text-xs font-medium flex items-center w-max"><i data-lucide="clock" class="w-3 h-3 mr-1"></i> Pendente</span>`;
                else statusBadge = `<span class="bg-red-50 text-red-700 border border-red-100 px-2 py-0.5 rounded-full text-xs font-medium flex items-center w-max"><i data-lucide="x-circle" class="w-3 h-3 mr-1"></i> Recusado</span>`;

                // Define platform for the table row
                const platform = sale.id.charCodeAt(0) % 2 === 0 ? 'Kiwify' : 'Eduzz';

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 transition-colors';
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap">${sale.dateStr}</td>
                    <td class="px-6 py-4">
                        <div class="font-medium text-slate-900">${sale.name}</div>
                        <div class="text-xs text-slate-400">${sale.email}</div>
                    </td>
                    <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs font-medium">${sale.product}</span></td>
                    <td class="px-6 py-4 text-slate-500">${sale.paymentMethod}</td>
                    <td class="px-6 py-4 text-slate-500">${platform}</td>
                    <td class="px-6 py-4">${statusBadge}</td>
                    <td class="px-6 py-4 text-right font-medium text-slate-900">${sale.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    <td class="px-6 py-4 text-center"><button class="text-slate-400 hover:text-slate-600 p-1 hover:bg-slate-100 rounded"><i data-lucide="more-horizontal" class="w-4 h-4"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            if (window.lucide) window.lucide.createIcons();
        }

        // --- Recent Sales Widget Logic ---
        function renderRecentSalesWidget() {
            try {
                const tbody = document.getElementById('recent-sales-body');
                if (!tbody) {
                    console.warn("Recent Sales Widget body not found");
                    return;
                }
                tbody.innerHTML = '';

                // Ensure ALL_SALES exists and has data
                if (!ALL_SALES || ALL_SALES.length === 0) {
                    // Retry generation if empty (fallback)
                    console.warn("ALL_SALES empty in widget, regenerating...");
                    if (typeof generateSalesData === 'function') generateSalesData();
                }

                // Show top 5 recent sales (regardless of date)
                const recent = ALL_SALES.slice(0, 5);

                recent.forEach(sale => {
                    let statusBadge = '';
                    if (sale.status === 'Aprovado') {
                        statusBadge = `<span class="bg-emerald-50 text-emerald-700 border border-emerald-100 px-2 py-0.5 rounded-full text-xs font-medium flex items-center w-max"><i data-lucide="check-circle" class="w-3 h-3 mr-1"></i> Aprovado</span>`;
                    } else if (sale.status === 'Pendente') {
                        statusBadge = `<span class="bg-amber-50 text-amber-700 border border-amber-100 px-2 py-0.5 rounded-full text-xs font-medium flex items-center w-max"><i data-lucide="clock" class="w-3 h-3 mr-1"></i> Pendente</span>`;
                    } else {
                        statusBadge = `<span class="bg-red-50 text-red-700 border border-red-100 px-2 py-0.5 rounded-full text-xs font-medium flex items-center w-max"><i data-lucide="x-circle" class="w-3 h-3 mr-1"></i> Recusado</span>`;
                    }

                    // MOCK PLATFORM (Deterministic)
                    const platform = sale.id.charCodeAt(0) % 2 === 0 ? 'Kiwify' : 'Eduzz';

                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${sale.dateStr}</td>
                        <td class="px-6 py-4">
                            <div class="font-medium text-slate-900">${sale.name}</div>
                            <div class="text-xs text-slate-400">${sale.email}</div>
                        </td>
                        <td class="px-6 py-4"><span class="bg-slate-100 text-slate-600 px-2 py-0.5 rounded text-xs font-medium">${sale.product}</span></td>
                        <td class="px-6 py-4 text-slate-500">${sale.paymentMethod}</td>
                        <td class="px-6 py-4 text-slate-500">${platform}</td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-right font-medium text-slate-900">${sale.value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
                    `;
                    tbody.appendChild(tr);
                });
                if (window.lucide) window.lucide.createIcons();
            } catch (e) {
                console.error("Error rendering Recent Sales Widget:", e);
            }
        }


        // --- REAL FACEBOOK DATA LOGIC ---
        // CRITICAL: Declarations moved UP before initApp to avoid TDZ errors
        let fbAccessToken = null;
        let selectedAdAccountId = null;
        let selectedCampaignId = 'all'; // Default

        // Helper: Wait for FB SDK
        function waitForFb(callback) {
            if (typeof FB !== 'undefined') {
                callback();
            } else {
                console.log("[Scale] Waiting for FB SDK...");
                setTimeout(() => waitForFb(callback), 500);
            }
        }


        // --- Init Function ---
        function initApp() {
            try {
                console.log("Initializing App...");

                // Auth Check First
                if (typeof checkAuth === 'function') checkAuth();

                // Check for Persistent FB Connection
                const storedFbToken = localStorage.getItem('fb_access_token');
                if (storedFbToken) {
                    console.log("Found stored FB Token, attempting auto-reconnect...");

                    // CRITICAL: Set global token BEFORE calling initRealFbData
                    fbAccessToken = storedFbToken;

                    // Update UI immediately
                    const btn = document.getElementById('btn-connect-fb');
                    const status = document.getElementById('status-fb');
                    if (btn && status) {
                        // We use a specific function/logic to update UI without triggering disconnect logic yet
                        btn.innerText = 'Desconectar';
                        btn.classList.replace('bg-blue-600', 'bg-slate-200');
                        btn.classList.replace('text-white', 'text-slate-700');
                        btn.classList.replace('hover:bg-blue-700', 'hover:bg-slate-300');
                        btn.disabled = false;
                        btn.onclick = disconnectFb;

                        status.innerText = `Conectado (Recuperado)`;
                        status.classList.replace('bg-slate-100', 'bg-blue-50');
                        status.classList.replace('text-slate-500', 'text-blue-600');
                        status.classList.remove('hidden');
                    }

                    // Fetch Data
                    initRealFbData(storedFbToken);
                }

                // Dashboard Date Picker
                if (typeof initCalendarHTML === 'function') initCalendarHTML();

                // Dashboard Default Dates
                // If not set, default to last 7 days
                if (!selectedStartDate) {
                    selectedEndDate = new Date();
                    selectedStartDate = new Date();
                    selectedStartDate.setDate(selectedStartDate.getDate() - 6);
                }

                if (typeof renderCalendars === 'function') renderCalendars();
                if (typeof updateDateInputs === 'function') updateDateInputs();

                // Sales Data Generation
                if (typeof generateSalesData === 'function') generateSalesData();

                // Render Dashboard
                if (typeof refreshDashboard === 'function') refreshDashboard();

                // Render Sales Tables
                if (typeof renderSalesTable === 'function') renderSalesTable();

                // Render Widget
                renderRecentSalesWidget();

                // Restore View
                const savedView = localStorage.getItem('last_active_view') || 'dashboard';
                if (typeof navigateTo === 'function') navigateTo(savedView);

                // Restore GoExplosion logic...
                if (localStorage.getItem('go_connected') === 'true') {
                    const form = document.getElementById('go-connect-form');
                    const msg = document.getElementById('go-connected-msg');
                    const status = document.getElementById('status-go');
                    if (form && msg && status) {
                        form.classList.add('hidden');
                        msg.classList.remove('hidden');
                        status.classList.remove('hidden');
                        status.innerText = 'Conectado';
                        msg.innerHTML = `<div class="flex items-center justify-between w-full"><span class="flex items-center"><i data-lucide="check" class="w-4 h-4 mr-1 text-emerald-500"></i> Sincronizando dados.</span><button onclick="disconnectGo()" class="text-xs text-red-500 hover:text-red-700 font-medium ml-4">Desconectar</button></div>`;
                        if (window.lucide) lucide.createIcons();
                    }
                }

                /* Sales Presets Init (Ensure listeners are attached) */
                const salesPresets = document.querySelectorAll('input[name="salesDatePreset"]');
                salesPresets.forEach((radio, index) => {
                    // Handled by inline script block above
                });

            } catch (e) {
                console.error("Init App Error", e);
                alert("Erro ao iniciar aplicação: " + e.message);
            }
        }

        // Run Init
        initApp();

        // FAILSAFE: Manual Event Listener for Login
        setTimeout(() => {
            const btn = document.getElementById('login-btn');
            if (btn) {
                btn.onclick = handleLogin; // Direct override
                console.log("Login button listener attached manually");
            }
        }, 1000);


        // Helper to toggle Account Dropdown
        function toggleAccountDropdown(forceClose = false) {
            const dropdown = document.getElementById('accountDropdown');
            if (!dropdown) return;
            if (forceClose) {
                dropdown.classList.add('hidden');
            } else {
                dropdown.classList.toggle('hidden');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const container = document.getElementById('accountSelectorContainer');
            if (container && !container.contains(e.target)) {
                toggleAccountDropdown(true);
            }
        });

        function initRealFbData(token) {
            waitForFb(() => {
                _initRealFbDataInternal(token);
            });
        }

        function _initRealFbDataInternal(token) {
            fbAccessToken = token;
            localStorage.setItem('fb_access_token', token); // Persist Token

            // RESET State on Reload (User Request):
            // Clear selected account so UI matches Logic
            localStorage.removeItem('fb_selected_account_id');
            localStorage.removeItem('fb_selected_account_name');
            selectedAdAccountId = null; // Clear memory variable

            if (!token) return;

            // Fetch Accounts - Explicitly passing access_token
            FB.api('/me/adaccounts', { access_token: token, fields: 'name,account_id,currency,account_status,business_name' }, function (response) {
                if (response.error) {
                    console.error('Error fetching accounts:', response.error);

                    // Handle Expired Token Gracefully
                    const msg = response.error.message || '';
                    if (msg.includes('Session has expired') || msg.includes('Error validating access token')) {
                        console.warn('FB Token Expired. Clearing session.');
                        localStorage.removeItem('fb_access_token');
                        localStorage.removeItem('fb_selected_account_id');
                        localStorage.removeItem('fb_selected_account_name');

                        // Reset UI if needed (though default is disconnected)
                        const btn = document.getElementById('btn-connect-fb');
                        const status = document.getElementById('status-fb');
                        if (btn) btn.innerText = 'Conectar Conta';
                        if (status) {
                            status.innerText = 'Desconectado';
                            status.classList.remove('bg-emerald-50', 'text-emerald-700');
                            status.classList.add('bg-slate-100', 'text-slate-500');
                        }
                        return; // Stop here, silent fail
                    }

                    alert('Erro ao buscar contas: ' + response.error.message);
                    return;
                }

                const accounts = response.data;
                const list = document.getElementById('accountListContainer');
                const btn = document.getElementById('accountSelectorBtn');

                if (list && btn) {
                    // Show the selector button
                    btn.classList.remove('hidden');
                    list.innerHTML = '';

                    if (accounts && accounts.length === 0) {
                        list.innerHTML = '<div class="p-3 text-xs text-slate-500 text-center">Nenhuma conta encontrada.</div>';
                    } else if (accounts) {
                        // Check for previously selected account
                        const storedId = localStorage.getItem('fb_selected_account_id');
                        let matched = false;

                        accounts.forEach(acc => {
                            const div = document.createElement('div');
                            div.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer flex flex-col border-b border-slate-50 last:border-0 transition-colors group';
                            const isSelected = storedId === acc.account_id;
                            if (isSelected) matched = true;

                            // Highlight selected visual (basic)
                            if (isSelected) div.classList.add('bg-blue-50/50');

                            div.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <span class="font-medium text-sm text-slate-700 group-hover:text-blue-700 ${isSelected ? 'text-blue-700' : ''}">${acc.name}</span>
                                    ${isSelected ? '<i data-lucide="check" class="w-3 h-3 text-blue-600"></i>' : ''}
                                </div>
                                <span class="text-[10px] text-slate-400">ID: ${acc.account_id} (${acc.currency})</span>
                            `;
                            div.onclick = () => {
                                selectAdAccount(acc.account_id, acc.name);
                                toggleAccountDropdown(true); // Close
                            };
                            list.appendChild(div);
                        });
                        if (window.lucide) lucide.createIcons();

                        // Auto-Select logic REMOVED by user request (Force manual selection)
                        /*
                        if (matched) {
                            const storedName = localStorage.getItem('fb_selected_account_name');
                            updateAccountLabel(storedName);
                            selectAdAccount(storedId, storedName, true); // true = silent/restore mode
                        }
                        */
                        if (response.data && response.data.length > 0) {
                            // Placeholder
                        }
                    }
                }
            });
        }

        async function handleManualRefresh() {
            const btn = document.getElementById('btn-refresh-manual');
            if (btn) btn.classList.add('animate-spin');

            // 1. Refresh FB Data (if account selected)
            const accId = localStorage.getItem('fb_selected_account_id');
            const token = localStorage.getItem('fb_access_token');

            const promises = [];

            if (accId && token) {
                console.log("Refreshing FB Data for:", accId);
                // Directly await the promise returned by fetchInsightsForAccount
                // We assume fetchInsightsForAccount handles partial errors (rejects or resolves)
                promises.push(fetchInsightsForAccount(accId, false, null)
                    .catch(err => console.warn("FB Refresh Warning:", err))
                );
            }

            // 2. Refresh Database Data (Supabase)
            if (typeof generateSalesData === 'function') {
                console.log("Refreshing Supabase Data...");
                promises.push(generateSalesData().catch(console.error));
            }

            let success = false;
            try {
                await Promise.all(promises);
                success = true;
            } catch (e) {
                console.error("Manual Refresh Error", e);
                alert("Erro ao atualizar dados.");
            } finally {
                if (btn) btn.classList.remove('animate-spin');
                refreshDashboard(); // Ensure final render

                if (success) {
                    // Use timeout to ensure UI updates (spinner stops) before alert blocks thread
                    setTimeout(() => {
                        alert("Dados atualizados com sucesso!");
                    }, 50);
                }
            }
        }

        function updateAccountLabel(name) {
            const lbl = document.getElementById('selectedAccountLabel');
            if (lbl) lbl.innerText = name.length > 20 ? name.substring(0, 18) + '...' : name;
        }

        function selectAdAccount(accountId, accountName, isRestore = false) {
            selectedAdAccountId = accountId;
            // Persist Selection
            localStorage.setItem('fb_selected_account_id', accountId);
            localStorage.setItem('fb_selected_account_name', accountName);

            updateAccountLabel(accountName);

            // Re-render list to update checks (lazy way: reload list or toggle classes manually. For now, we leave as is)

            const overlay = document.getElementById('global-loading-overlay');
            if (overlay && !isRestore) {
                overlay.classList.remove('hidden');
                overlay.classList.remove('opacity-0');
                overlay.classList.add('flex');
                const msg = overlay.querySelector('span');
                if (msg) msg.innerText = 'Atualizando dados...';
            }

            // 1. Fetch Campaigns - Explicitly passing access_token
            FB.api(`/act_${accountId}/campaigns`, { access_token: fbAccessToken, fields: 'name,status', limit: 300 }, function (campResponse) {
                if (campResponse.data) {
                    updateCampaignSelector(campResponse.data);
                }
            });

            // 2. Fetch Insights (Async)
            fetchInsightsForAccount(accountId, isRestore, overlay);
        }

        function fetchInsightsForAccount(accountId, isRestore, overlay) {
            return new Promise((resolve, reject) => {
                // Calculate Range: Last 90 days + Today
                const today = new Date();
                const past = new Date();
                past.setDate(today.getDate() - 90);

                const formatDate = (d) => {
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                const params = {
                    access_token: fbAccessToken,
                    level: 'campaign',
                    time_increment: 1,
                    time_range: JSON.stringify({ since: formatDate(past), until: formatDate(today) }),
                    limit: 5000,
                    fields: 'campaign_name,campaign_id,spend,impressions,clicks,actions,action_values'
                };

                FB.api(`/act_${accountId}/insights`, params, function (insightResponse) {
                    if (overlay && !isRestore) { // Fade out if user triggered
                        overlay.classList.add('opacity-0');
                        setTimeout(() => {
                            overlay.classList.remove('flex', 'opacity-0');
                            overlay.classList.add('hidden');
                        }, 300);
                    }

                    if (insightResponse.error) {
                        console.error("Insights Error", insightResponse.error);
                        if (!isRestore) alert('Erro ao baixar dados: ' + insightResponse.error.message);
                        reject(insightResponse.error); // Reject promise
                        return;
                    }

                    console.log("[Scale] Insights Rows Fetched:", insightResponse.data ? insightResponse.data.length : 0);

                    // Process Data
                    processFbInsights(insightResponse.data);
                    resolve(insightResponse.data); // Resolve promise
                });
            });
        }

        function updateCampaignSelector(campaigns) {
            const select = document.getElementById('campaign-select');
            if (!select) return;

            // Keep 'all' option
            select.innerHTML = '<option value="all">Todas as campanhas</option>';

            campaigns.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id; // Use ID as value
                opt.innerText = c.name; // Show Real Name
                select.appendChild(opt);
            });

            // Allow re-selection if persisted (optional, but good UX)
            // select.value = 'all'; 
        }

        function updateSelectedCampaign(val) {
            console.log("Campaign Filter Changed:", val);
            selectedCampaignId = val;
            refreshDashboard();
        }

        function updateTextFilter(val) {
            textFilterValue = val;
            refreshDashboard();
        }

        function triggerTextSearch() {
            const val = document.getElementById('textFilterInput').value;
            textFilterValue = val;
            // Now trigger full refresh (with animation)
            handleManualRefresh();
        }

        function processFbInsights(data) {
            console.log("[Scale] Raw FB Insights Data:", data); // DEBUG

            if (!data || data.length === 0) {
                console.warn("[Scale] No data returned from FB Insights API for the last 90 days.");
                alert("Não há dados de anúncios para esta conta nos últimos 90 dias.");
                return;
            }

            // 1. Reset Investment Data in DAILY_DATA (to clear previous account data)
            DAILY_DATA.forEach(d => {
                d.all.investment = 0;
                // Remove old campaign keys if we want to be strict, but keeping them harmlessly with 0 inv is fine.
                // Better: iterate keys and zero them if they look like campaign IDs? 
                // For simplicity/safety: we just zero the 'all' aggregate for now. 
                // Ideally we should wipe the dynamic keys too to avoid mixing accounts.
                Object.keys(d).forEach(k => {
                    if (d[k] && typeof d[k] === 'object' && d[k].investment !== undefined) {
                        d[k].investment = 0;
                    }
                });
            });

            // 2. Merge FB Investment Data
            data.forEach(row => {
                const dStr = row.date_start;
                // Capture Name Mapping
                if (row.campaign_id && row.campaign_name) {
                    CAMPAIGN_NAMES[row.campaign_id] = row.campaign_name;
                    // Also ensure init in DAILY_DATA for safety (though logic handles d[cid] check)
                }

                // Find matching day in DAILY_DATA (ignoring time)
                // dStr is YYYY-MM-DD
                const dayData = DAILY_DATA.find(d => {
                    const year = d.date.getFullYear();
                    const month = String(d.date.getMonth() + 1).padStart(2, '0');
                    const day = String(d.date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}` === dStr;
                });

                if (dayData) {
                    const spend = parseFloat(row.spend || 0);

                    // Aggregate Global Investment
                    dayData.all.investment += spend;

                    // NOTE: We intentionally DO NOT update revenue/participants from FB Pixel
                    // because Supabase is the Single Source of Truth for Sales.
                    // This fixes the "fictitious numbers" issue.

                    // Aggregate Campaign Specific
                    const cid = row.campaign_id;
                    if (!dayData[cid]) {
                        // Init campaign slot if missing
                        dayData[cid] = { investment: 0, revenue: 0, participants: 0, vips: 0, indiv: 0, double: 0 };
                    }
                    dayData[cid].investment += spend;

                    // If we wanted Pixel ROI matching later, we'd add logic here, 
                    // but user specifically wants Database matching.
                }
            });

            console.log("[Scale] Merged FB Investment into DAILY_DATA.");

            // Update Status Feedback
            const status = document.getElementById('status-fb');
            if (status) {
                status.innerText = 'Conectado (API Real)';
                status.classList.remove('text-blue-600', 'bg-blue-50');
                status.classList.add('bg-emerald-50', 'text-emerald-700');
            }

            // Refresh Dashboard
            refreshDashboard();
            alert("Dados do Facebook atualizados com sucesso!");
        }
    </script>
    <!-- Global Transition Overlay -->
    <!-- Deploy Trigger: 2026-01-27-Persistence-Fix -->
    <div id="global-loading-overlay"
        class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[100] hidden flex-col items-center justify-center transition-opacity duration-300">
        <div class="flex flex-col items-center animate-in fade-in zoom-in duration-300">
            <div class="relative w-16 h-16 mb-4">
                <i data-lucide="loader-2" class="w-16 h-16 text-red-600 animate-spin absolute inset-0 opacity-20"></i>
                <i data-lucide="loader-2" class="w-16 h-16 text-red-600 animate-spin absolute inset-0"
                    style="animation-duration: 1.5s;"></i>
            </div>
            <span class="text-lg font-medium text-slate-800">Carregando...</span>
        </div>
    </div>
    <!-- Load WhatsApp Logic (INLINE FAILSAFE) -->
    <script>
        // --- WHATSAPP LOGIC (INLINE) ---
        console.log("WhatsApp Inline Logic Loaded");

        // Initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadWaInstances();
            updateWaCounters();
        });

        // TABS LOGIC
        window.switchWaTab = function (tabName) {
            // Update Headers
            const tabs = ['instances', 'groups', 'alerts'];
            tabs.forEach(t => {
                const btn = document.getElementById(`tab-btn-${t}`);
                const content = document.getElementById(`tab-content-${t}`);

                if (t === tabName) {
                    btn.classList.add('border-orange-500', 'text-orange-600');
                    btn.classList.remove('border-transparent', 'text-slate-500');
                    content.classList.remove('hidden');
                } else {
                    btn.classList.remove('border-orange-500', 'text-orange-600');
                    btn.classList.add('border-transparent', 'text-slate-500');
                    content.classList.add('hidden');
                }
            });

            // Toggle "New Instance" button visibility
            const newBtn = document.getElementById('btn-new-instance');
            if (newBtn) {
                if (tabName === 'instances') newBtn.classList.remove('hidden');
                else newBtn.classList.add('hidden');
            }
        };

        // --- INSTANCE MANAGEMENT ---

        function loadWaInstances() {
            const container = document.getElementById('instance-list-container');
            if (!container) return;

            const instances = JSON.parse(localStorage.getItem('wa_instances') || '[]');
            const countBadge = document.getElementById('count-instances');
            if (countBadge) countBadge.innerText = instances.length;

            if (instances.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12 bg-slate-50 rounded-xl border border-dashed border-slate-300">
                        <p class="text-slate-500">Nenhuma instância conectada.</p>
                    </div>`;
                return;
            }

            container.innerHTML = instances.map(inst => `
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col justify-between h-full transition-shadow hover:shadow-md">
                    <!-- Header -->
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 class="font-bold text-slate-800">${inst.name}</h3>
                                <span class="px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wide ${inst.status === 'connected' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}">
                                    ${inst.status === 'connected' ? 'Conectado' : 'Desconectado'}
                                </span>
                            </div>
                            <p class="text-sm font-mono text-slate-500">${inst.phone || 'Sem número'}</p>
                        </div>
                    </div>

                    <!-- Body -->
                    <div class="mb-6 flex-1">
                        <p class="text-xs text-slate-500 line-clamp-2">${inst.desc || 'Sem descrição'}</p>
                    </div>

                    <!-- Actions Grid -->
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button class="flex items-center justify-center gap-2 px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-lg text-xs font-medium transition-colors border border-slate-200">
                            <i data-lucide="qr-code" class="w-3.5 h-3.5"></i> QR Code
                        </button>
                        <button class="flex items-center justify-center gap-2 px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-lg text-xs font-medium transition-colors border border-slate-200">
                            <i data-lucide="webhook" class="w-3.5 h-3.5"></i> Webhook
                        </button>
                        <button class="flex items-center justify-center gap-2 px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-lg text-xs font-medium transition-colors border border-slate-200">
                            <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i> Sincronizar
                        </button>
                        <button class="flex items-center justify-center gap-2 px-3 py-2 bg-slate-50 hover:bg-slate-100 text-slate-600 rounded-lg text-xs font-medium transition-colors border border-slate-200">
                            <i data-lucide="power" class="w-3.5 h-3.5"></i> Reiniciar
                        </button>
                    </div>

                    <!-- Footer Action -->
                    <button onclick="deleteWaInstance('${inst.id}')" class="w-full py-2 text-red-500 hover:bg-red-50 rounded-lg text-xs font-bold transition-colors flex items-center justify-center border border-transparent hover:border-red-100">
                        <i data-lucide="trash-2" class="w-3.5 h-3.5 mr-1.5"></i> Desconectar
                    </button>
                </div>
            `).join('');

            if (window.lucide) lucide.createIcons();
        }

        function updateWaCounters() {
            const instances = JSON.parse(localStorage.getItem('wa_instances') || '[]');
            const countBadge = document.getElementById('count-instances');
            if (countBadge) countBadge.innerText = instances.length;
        }

        window.deleteWaInstance = function (id) {
            if (!confirm('Tem certeza que deseja desconectar e remover esta instância?')) return;

            let instances = JSON.parse(localStorage.getItem('wa_instances') || '[]');
            instances = instances.filter(i => i.id !== id);
            localStorage.setItem('wa_instances', JSON.stringify(instances));

            loadWaInstances();
            updateWaCounters();
        };

        // --- CONFIG UAZAPI ---
        const UAZAPI_CONFIG = {
            baseUrl: 'https://free.uazapi.com',
            token: 'ZaW1qwTEkuq7Ub1cBUuyMiK5bNSu3nnMQ9lh7klElc2clSRV8t'
        };

        // GLOBAL MODAL FUNCTIONS
        window.openNewInstanceModal = function () {
            console.log("Opening WhatsApp Modal (Real API Mode)");
            const modal = document.getElementById('instance-modal');
            const content = document.getElementById('instance-modal-content');

            // Reset to Step 1
            document.getElementById('step-name').classList.remove('hidden');
            document.getElementById('qr-loading').classList.add('hidden');
            document.getElementById('qr-display').classList.add('hidden');
            document.getElementById('qr-expired').classList.add('hidden');
            document.getElementById('qr-success').classList.add('hidden');

            // Clear Input
            // Clear Input
            const nameInput = document.getElementById('wa-name-input');
            if (nameInput) nameInput.value = '';

            if (modal) {
                modal.classList.remove('hidden');
                void modal.offsetWidth;
                modal.classList.remove('opacity-0');

                if (content) {
                    content.classList.remove('opacity-0', 'scale-95');
                    content.classList.add('scale-100', 'opacity-100');
                }
            } else {
                alert("Erro: Modal não encontrado!");
            }
        };

        // 1. CREATE INSTANCE & GET QR
        window.initRealConnection = async function () {
            const nameInput = document.getElementById('wa-name-input');
            const tokenInput = document.getElementById('new-instance-token');

            const instanceName = nameInput.value.trim();
            const manualToken = tokenInput ? tokenInput.value.trim() : '';

            if (!instanceName) {
                alert("Por favor, digite um nome para a instância.");
                return;
            }

            // Transition UI -> Loading
            const stepName = document.getElementById('step-name');
            if (stepName) stepName.classList.add('hidden');
            document.getElementById('qr-loading').classList.remove('hidden');

            try {
                // FLOW 1: Manual Token (Direct Connect)
                if (manualToken) {
                    console.log(`Connecting with Manual Token: ${manualToken}...`);

                    let data = null;

                    // Strategy 1: POST /instance/connect (No Params)
                    try {
                        const res = await fetch(`${UAZAPI_CONFIG.baseUrl}/instance/connect`, {
                            method: 'POST',
                            headers: { 'token': manualToken, 'Content-Type': 'application/json' },
                            body: JSON.stringify({ instanceName: instanceName })
                        });
                        console.log("Strategy 1 (POST) status:", res.status);

                        if (res.ok) {
                            data = await res.json();
                            console.log("Strategy 1 Data:", data);
                        } else {
                            // Try to read error content
                            try {
                                const err = await res.json();
                                console.warn("POST Error Body:", err);
                            } catch (e) { }
                        }
                    } catch (e) { console.warn("POST Connect failed, trying GET fallback...", e); }

                    // Strategy 2: If POST failed/empty, Try GET /instance/connect/{name}
                    if (!data || (!data.qrcode && !data.base64)) {
                        console.log("Strategy 1 Failed. Trying GET Strategy...");
                        try {
                            const res = await fetch(`${UAZAPI_CONFIG.baseUrl}/instance/connect/${instanceName}`, {
                                method: 'GET',
                                headers: { 'token': manualToken }
                            });
                            console.log("Strategy 2 (GET) status:", res.status);
                            if (res.ok) {
                                data = await res.json();
                                console.log("Strategy 2 Data:", data);
                            }
                        } catch (e) { console.warn("GET Connect failed too", e); }
                    }

                    // Helper to deep extract QR
                    const getQr = (d) => {
                        if (!d) return null;
                        if (d.qrcode) return d.qrcode;
                        if (d.base64) return d.base64;
                        if (d.instance) {
                            if (d.instance.qrcode) return d.instance.qrcode;
                            if (d.instance.base64) return d.instance.base64;
                        }
                        return null;
                    };

                    const qrBase64 = getQr(data);

                    if (qrBase64) {
                        document.getElementById('qr-loading').classList.add('hidden');
                        document.getElementById('qr-display').classList.remove('hidden');

                        const img = document.getElementById('qr-code-img');
                        img.src = qrBase64.startsWith('data:image') ? qrBase64 : `data:image/png;base64,${qrBase64}`;

                        // Start Polling with SPECIFIC Token
                        startPollingStatus(instanceName, manualToken);
                        return;
                    } else if (data && data.instance && data.instance.status === 'connected') {
                        // Already connected!
                        finalizeConnection(instanceName, manualToken);
                        return;
                    } else {
                        throw new Error((data ? (data.message || JSON.stringify(data)) : "Sem resposta válida da API") || "Falha ao obter QR Code.");
                    }
                }

                // FLOW 2: Legacy Creation (Admin Token)
                console.log(`Creating instance: ${instanceName}...`);
                const response = await fetch(`${UAZAPI_CONFIG.baseUrl}/instance/create`, {
                    method: 'POST',
                    headers: {
                        'token': UAZAPI_CONFIG.token,
                        'apikey': UAZAPI_CONFIG.token,
                        'Authorization': `Bearer ${UAZAPI_CONFIG.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ instanceName: instanceName })
                });

                const data = await response.json();
                console.log("Create Response:", data);

                if (data && (data.qrcode || data.base64)) {
                    const qrBase64 = data.qrcode || data.base64;
                    document.getElementById('qr-loading').classList.add('hidden');
                    document.getElementById('qr-display').classList.remove('hidden');

                    const img = document.getElementById('qr-code-img');
                    img.src = qrBase64.startsWith('data:image') ? qrBase64 : `data:image/png;base64,${qrBase64}`;

                    startPollingStatus(instanceName);
                } else {
                    const isExistsError = data && data.message && (
                        data.message.toLowerCase().includes("exists") ||
                        data.message.toLowerCase().includes("já existe")
                    );

                    if (isExistsError) {
                        connectExistingInstance(instanceName);
                    } else {
                        // Fallback: If 401/Unauthorized, it means we can't create. Suggest Manual Token.
                        if (response.status === 401) {
                            alert("Não foi possível criar a instância automaticamente (Erro 401).\n\nSOLUÇÃO:\n1. Crie a instância '" + instanceName + "' no Painel da UAZAPI.\n2. Copie o TOKEN dela.\n3. Cole no campo 'Token da Instância' aqui.");
                            window.closeNewInstanceModal();
                        } else {
                            console.warn("Create failed, attempting legacy connect...", data);
                            connectExistingInstance(instanceName);
                        }
                    }
                }

            } catch (error) {
                console.error("API Error:", error);
                alert(`Erro ao conectar na API: ${error.message}`);
                window.closeNewInstanceModal();
            }
        };

        // Fallback for existing instances
        window.connectExistingInstance = async function (instanceName) {
            console.log(`Fallback: Connecting to existing ${instanceName}`);
            try {
                // GET is the confirmed correct method for this server (POST gives 405)
                const response = await fetch(`${UAZAPI_CONFIG.baseUrl}/instance/connect/${instanceName}`, {
                    method: 'GET',
                    headers: { 'token': UAZAPI_CONFIG.token, 'apikey': UAZAPI_CONFIG.token }
                });

                // Handle 404 specifically
                if (response.status === 404) {
                    alert(`Instância "${instanceName}" não encontrada! (Erro 404)\n\nCertifique-se de que você CRIOU ela no Painel da UAZAPI antes de clicar em "Gerar QR Code" aqui.`);
                    window.closeNewInstanceModal();
                    return;
                }

                const data = await response.json();

                if (data && (data.base64 || data.qrcode)) {
                    const qrBase64 = data.base64 || data.qrcode;
                    document.getElementById('qr-loading').classList.add('hidden');
                    document.getElementById('qr-display').classList.remove('hidden');
                    const img = document.getElementById('qr-code-img');
                    img.src = qrBase64.startsWith('data:image') ? qrBase64 : `data:image/png;base64,${qrBase64}`;
                    startPollingStatus(instanceName);
                } else {
                    alert("Não consegui conectar na instância existente: " + (data.message || JSON.stringify(data)));
                    window.closeNewInstanceModal();
                }
            } catch (e) {
                alert("Erro ao conectar instância existente: " + e.message);
                window.closeNewInstanceModal();
            }
        }

        // 2. POLL STATUS
        let pollInterval = null;
        function startPollingStatus(instanceName, manualToken = null) {
            if (pollInterval) clearInterval(pollInterval);

            let attempts = 0;
            const maxAttempts = 100; // ~5 min timeout

            pollInterval = setInterval(async () => {
                attempts++;
                if (attempts > maxAttempts) {
                    clearInterval(pollInterval);
                    document.getElementById('qr-expired').classList.remove('hidden');
                    return;
                }

                try {
                    let state = 'disconnected';
                    let currentQr = null;

                    if (manualToken) {
                        // Manual Token Polling (Root Status endpoint)
                        const res = await fetch(`${UAZAPI_CONFIG.baseUrl}/status`, {
                            method: 'GET',
                            headers: { 'token': manualToken }
                        });
                        const data = await res.json();

                        // Extract State
                        if (data && data.status && data.status.checked_instance) {
                            state = data.status.checked_instance.connection_status;
                            // Check for QR inside status
                            if (data.status.checked_instance.qrCode) currentQr = data.status.checked_instance.qrCode;
                            if (data.status.checked_instance.base64) currentQr = data.status.checked_instance.base64;
                        }
                        // Also check top level if API varies
                        if (data.qrcode) currentQr = data.qrcode;
                        if (data.base64) currentQr = data.base64;

                    } else {
                        // Legacy Polling
                        const res = await fetch(`${UAZAPI_CONFIG.baseUrl}/instance/connectionState/${instanceName}`, {
                            method: 'GET',
                            headers: {
                                'token': UAZAPI_CONFIG.token,
                                'apikey': UAZAPI_CONFIG.token
                            }
                        });
                        const statusData = await res.json();
                        state = statusData.state || statusData.status;
                    }

                    console.log(`Polling ${instanceName}: ${state} | QR Present: ${!!currentQr}`);

                    // If we got a NEW QR code during polling, update the view!
                    if (currentQr) {
                        const img = document.getElementById('qr-code-img');
                        const newSrc = currentQr.startsWith('data:image') ? currentQr : `data:image/png;base64,${currentQr}`;
                        if (img && img.src !== newSrc) img.src = newSrc;
                        // DO NOT FINALIZE if we have a QR code, even if status says 'open' (it might be 'open' for scanning)
                        return;
                    }

                    if (state === 'connected') {
                        // DISABLE AUTO-FINALIZE to prevent premature closing
                        // clearInterval(pollInterval);
                        // finalizeConnection(instanceName, manualToken);

                        // Just notify in console, let user click "Já escaneiei"
                        console.log("Status detected as CONNECTED. Waiting for user confirmation.");
                    }
                } catch (e) {
                    console.warn("Polling error:", e);
                }
            }, 3000); // Check every 3s
        }

        // 3. FINALIZE & SAVE
        async function finalizeConnection(instanceName, manualToken = null) {
            // UI Success
            document.getElementById('qr-display').classList.add('hidden');
            document.getElementById('qr-success').classList.remove('hidden');

            try {
                // SAVE TO LOCAL STORAGE
                const newInstance = {
                    id: manualToken || ('wa-' + Date.now()),
                    name: instanceName,
                    phone: "Carregando...",
                    desc: 'Conectado via UAZAPI',
                    status: 'connected',
                    token: manualToken,
                    createdAt: new Date().toISOString()
                };

                const instances = JSON.parse(localStorage.getItem('wa_instances') || '[]');
                instances.push(newInstance);
                localStorage.setItem('wa_instances', JSON.stringify(instances));

                // Removed auto-close timeout. User must close manually.
                loadWaInstances();
                updateWaCounters();

            } catch (e) {
                console.error("Finalize error", e);
                window.closeNewInstanceModal();
            }
        }

        window.closeNewInstanceModal = function () {
            if (pollInterval) clearInterval(pollInterval); // Stop Polling

            const modal = document.getElementById('instance-modal');
            const content = document.getElementById('instance-modal-content');

            if (modal) {
                modal.classList.add('opacity-0');
                if (content) {
                    content.classList.add('opacity-0', 'scale-95');
                    content.classList.remove('scale-100', 'opacity-100');
                }
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        };

        // Navigation Logic Extension for WhatsApp
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = function (viewId) {
            originalNavigateTo(viewId);
            // No init needed for simple modal logic
        };
    </script>
    <!-- Duplicate Modal Deleted -->

</body>

</html>