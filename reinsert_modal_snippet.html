<!-- New Agent Modal -->
<div id="agent-modal"
    class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 transform transition-all scale-95 opacity-0 duration-300"
        id="agent-modal-content">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <div>
                <h3 class="text-lg font-bold text-slate-800">Editar Agente</h3>
                <p class="text-xs text-slate-500 mt-1">Atualize as configurações do agente de IA</p>
            </div>
            <button onclick="closeAgentModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        <!-- (Agent Content Omitted for Brevity, assuming it exists in file) -->
        <!-- ... -->
    </div>
</div>

<!-- WhatsApp Instance Modal (Re-inserted) -->
<div id="instance-modal"
    class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center transition-opacity opacity-0">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm mx-4 transform transition-all scale-95 opacity-0 duration-300"
        id="instance-modal-content">
        <!-- Header -->
        <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
            <div>
                <h3 class="text-lg font-bold text-slate-800">Nova Instância</h3>
                <p class="text-xs text-slate-500 mt-1">Conecte um novo número de WhatsApp</p>
            </div>
            <button onclick="closeNewInstanceModal()" class="text-slate-400 hover:text-slate-600 transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>

        <!-- Content -->
        <div class="p-6 flex flex-col items-center justify-center space-y-6" id="qr-content-wrapper">

            <!-- Step 1: Input Name & Token -->
            <div id="step-name" class="w-full">
                <label class="block text-sm font-medium text-slate-700 mb-1">Nome da Instância</label>
                <input type="text" id="wa-name-input" class="w-full p-2 border border-slate-200 rounded-lg mb-4"
                    placeholder="Ex: Loja Principal">

                <label class="block text-sm font-medium text-slate-700 mb-1">
                    Token da Instância (Opcional)
                    <span class="block text-xs text-slate-400 font-normal">Pegue no painel da UAZAPI. Se usar este
                        token, a conexão é direta.</span>
                </label>
                <input type="text" id="new-instance-token"
                    class="w-full p-2 border border-slate-200 rounded-lg text-sm font-mono mb-4"
                    placeholder="Ex: 7a78c87b-...">

                <div class="flex justify-end space-x-2 mt-2">
                    <button onclick="closeNewInstanceModal()"
                        class="px-4 py-2 text-slate-600 hover:bg-slate-50 rounded-lg">Cancelar</button>
                    <button onclick="initRealConnection()"
                        class="px-4 py-2 bg-gradient-to-r from-orange-500 to-pink-500 text-white rounded-lg hover:opacity-90 transition-opacity">
                        Gerar QR Code
                    </button>
                </div>
            </div>

            <!-- QR Loading State -->
            <div id="qr-loading" class="hidden flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin mb-3">
                </div>
                <p class="text-sm font-medium text-slate-600">Conectando à API...</p>
                <p class="text-xs text-slate-400 mt-1">Isso pode levar alguns segundos</p>
            </div>

            <!-- QR Display State -->
            <div id="qr-display" class="hidden w-full flex flex-col items-center">
                <div class="w-48 h-48 bg-white p-2 rounded-lg border-2 border-slate-100 shadow-sm relative overflow-hidden"
                    id="qr-image-container">
                    <!-- IMAGEM QR INJECTED HERE -->
                </div>
                <div class="mt-4 text-center">
                    <p class="text-sm font-medium text-slate-800 mb-1">Abra o WhatsApp e escaneie</p>
                    <p class="text-xs text-slate-500">Menu > Aparelhos conectados > Conectar um aparelho</p>
                </div>
            </div>

            <!-- QR Expired/Error State -->
            <div id="qr-expired" class="hidden flex flex-col items-center text-center">
                <div class="w-12 h-12 bg-red-50 rounded-full flex items-center justify-center mb-3">
                    <i data-lucide="alert-circle" class="w-6 h-6 text-red-500"></i>
                </div>
                <h3 class="font-medium text-slate-800 mb-1">Erro na Conexão</h3>
                <p class="text-sm text-slate-500 mb-4" id="qr-error-msg">Ocorreu um erro ao gerar o QR Code.</p>
                <button onclick="openNewInstanceModal()"
                    class="text-sm text-orange-600 hover:text-orange-700 font-medium">Tentar Novamente</button>
            </div>

            <!-- Success State -->
            <div id="qr-success" class="hidden flex flex-col items-center text-center">
                <div
                    class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center mb-4 animate-in zoom-in duration-300">
                    <i data-lucide="check" class="w-8 h-8 text-emerald-500"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2">Conectado!</h3>
                <p class="text-slate-500 text-sm">Aparelho sincronizado com sucesso.</p>
            </div>

        </div>
    </div>
</div>